import React from 'react';
import { Search, MapPin, Building, X, ThumbsUp, Star, QrCode, ArrowLeft, Users, Heart, PlusCircle, Home, Gift, User, Bell, Tag, Share2, CheckCircle, Award, ShoppingBag, ChevronRight, Clock, Wallet, Coffee, Minus, Plus, ShoppingCart, Loader2, LogOut, Camera, Info, UploadCloud, Badge, ShieldCheck, Plane, Building2, MessageCircle, Send } from 'lucide-react';
import { initializeApp } from 'firebase/app';
import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, onSnapshot, addDoc, query, where, writeBatch, getDocs, arrayUnion, serverTimestamp, increment, orderBy, arrayRemove } from 'firebase/firestore';
import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "firebase/auth";

// --- Firebase Configuration ---
const firebaseConfig = {
  apiKey: "AIzaSyCH19CEf7ybXeJE-ZErIScVc8fXFrwh5Zw",
  authDomain: "corporate-perks-app.firebaseapp.com",
  projectId: "corporate-perks-app",
  storageBucket: "corporate-perks-app.firebasestorage.app",
  messagingSenderId: "104236011894",
  appId: "1:104236011894:web:f858f533ac72594458ea57"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// --- Helper Functions ---
const translateAuthError = (code) => {
  const map = {
    'auth/invalid-credential': '帳號或密碼錯誤，或帳號不存在。',
    'auth/invalid-email': '電子郵件格式不正確',
    'auth/user-disabled': '此帳號已被停用',
    'auth/user-not-found': '找不到此帳號',
    'auth/wrong-password': '密碼錯誤',
    'auth/email-already-in-use': '此電子郵件已被註冊',
    'auth/weak-password': '密碼過於簡單（至少 6 碼）',
    'auth/operation-not-allowed': '此登入方式未啟用',
    'auth/unauthorized-domain': '網域未授權',
    'auth/network-request-failed': '網路請求失敗，請檢查您的連線',
    'auth/too-many-requests': '嘗試次數過多，請稍後再試',
  };
  return map[code] || code || '發生未知錯誤';
};

const formatRelativeTime = (date) => {
    if (!date) return '';
    const now = new Date();
    const diff = now.getTime() - date.getTime();
    const seconds = Math.floor(diff / 1000);
    const minutes = Math.floor(seconds / 60);
    const hours = Math.floor(minutes / 60);
    const days = Math.floor(hours / 24);

    if (days > 0) return `${days}天前`;
    if (hours > 0) return `${hours}小時前`;
    if (minutes > 0) return `${minutes}分鐘前`;
    return '剛剛';
};


// --- Mock Data for Initial Seeding ---
const MOCK_COMPANIES = {
    'company-a': { id: 'company-a', name: '卓越科技有限公司', address: '台北市信義區信義路五段7號 89樓', phone: '02-8101-8888', welfareId: 'WEL-TW-101' },
    'company-b': { id: 'company-b', name: '創新國際股份有限公司', address: '新竹市東區科學園區工業東二路1號', phone: '03-578-1234', welfareId: 'WEL-HS-007' },
};

const MOCK_STORES = [
    { id: 'store-1', name: '星巴克 Starbucks', category: '美食餐飲', offer: '憑 App QR Code，所有飲品享第二杯半價優惠。', location: '全台門市', logo: 'https://placehold.co/100x100/036635/FFFFFF?text=Starbucks', details: '此優惠不適用於外送平台、預訂服務。不可與其他優惠合併使用。' },
    { id: 'store-2', name: '威秀影城 Vieshow Cinemas', category: '休閒娛樂', offer: '出示 App QR Code，享 2D 電影票 NT$240 優惠價。', location: '全台據點', logo: 'https://placehold.co/100x100/ED1C24/FFFFFF?text=Vieshow', details: '每證每日限購 4 張。不適用於 3D、IMAX、特殊影廳。詳細辦法依影城公告為準。' },
    { id: 'store-3', name: '誠品生活 eslite', category: '生活百貨', offer: '圖書、文具、雜誌享 9 折優惠。', location: '全台門市', logo: 'https://placehold.co/100x100/008855/FFFFFF?text=eslite', details: '特價品、餐飲、部分專櫃除外。' },
];

const MOCK_GROUP_BUYS = [
    { id: 'gb-1', name: '辦公室零食箱 (豪華版)', description: '精選來自世界各地的20種人氣零食，從經典洋芋片到健康堅果棒，一次滿足您辦公室的味蕾。適合部門分享，提振下午精神！', marketPrice: 1200, groupPrice: 899, groupSize: 3, imageUrl: 'https://placehold.co/600x400/FFC107/FFFFFF?text=零食箱', endDate: new Date(Date.now() + 2 * 24 * 60 * 60 * 1000).toISOString(), tags: ['零食', '辦公室', '分享'] },
    { id: 'gb-2', name: '人氣店家手作蛋捲禮盒', description: '每日新鮮現做，採用頂級原料，口感酥脆香濃。無論是送禮還是自用，都是最有誠意的選擇。限量供應，售完為止。', marketPrice: 500, groupPrice: 380, groupSize: 2, imageUrl: 'https://placehold.co/600x400/4CAF50/FFFFFF?text=蛋捲禮盒', endDate: new Date(Date.now() + 5 * 24 * 60 * 60 * 1000).toISOString(), tags: ['甜點', '送禮', '限量'] },
    { id: 'gb-3', name: '精品濾掛咖啡組', description: '嚴選阿拉比卡咖啡豆，中度烘焙帶有果香風味，讓您在辦公室也能享受一杯好咖啡。', marketPrice: 800, groupPrice: 550, groupSize: 5, imageUrl: 'https://placehold.co/600x400/795548/FFFFFF?text=咖啡組', endDate: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(), tags: ['咖啡', '飲品', '提神'] }, // Ended
];

const MOCK_WISHLIST = [
    { text: '希望公司樓下開一間海底撈', category: '店家', wishes: 128, wishedBy: [], creatorId: 'mock-user-1', createdAt: new Date(Date.now() - 86400000 * 3), commentCount: 2 },
    { text: '想要一台Dyson吸塵器當生日禮物', category: '禮物', wishes: 73, wishedBy: [], creatorId: 'mock-user-2', createdAt: new Date(Date.now() - 86400000 * 2), commentCount: 5 },
    { text: '想去冰島看極光', category: '旅遊', wishes: 210, wishedBy: [], creatorId: 'mock-user-1', createdAt: new Date(Date.now() - 86400000), commentCount: 10 },
    { text: '希望能順利交到女朋友', category: '生活', wishes: 55, wishedBy: [], creatorId: 'mock-user-2', createdAt: new Date(), commentCount: 0 },
];

const MOCK_TEA_STORES = [
    { id: 'ts-1', name: '50嵐', logo: 'https://placehold.co/100x100/F9A825/000000?text=50嵐', description: '台灣知名連鎖手搖飲品牌。' },
    { id: 'ts-2', name: '可不可熟成紅茶', logo: 'https://placehold.co/100x100/000000/FFFFFF?text=KEBUKE', description: '專注於熟成紅茶的特色飲品店。' },
];

const MOCK_TEA_MENU = {
    'ts-1': [
        { id: '50-1', name: '珍珠奶茶', price: 50, options: { sugar: ['正常糖', '少糖', '半糖', '微糖', '無糖'], ice: ['正常冰', '少冰', '微冰', '去冰', '溫', '熱'] }, imageUrl: 'https://placehold.co/400x400/FFC107/000000?text=珍珠奶茶' },
        { id: '50-2', name: '四季春青茶', price: 35, options: { sugar: ['正常糖', '少糖', '半糖', '微糖', '無糖'], ice: ['正常冰', '少冰', '微冰', '去冰'] }, imageUrl: 'https://placehold.co/400x400/8BC34A/FFFFFF?text=四季春' },
    ],
    'ts-2': [
        { id: 'kbk-1', name: '熟成紅茶', price: 35, options: { sugar: ['正常', '八分', '五分', '三分', '無糖'], ice: ['正常', '少冰', '微冰', '去冰', '溫', '熱'] }, imageUrl: 'https://placehold.co/400x400/795548/FFFFFF?text=熟成紅茶' },
        { id: 'kbk-2', name: '白玉歐蕾', price: 60, options: { sugar: ['正常', '八分', '五分', '三分', '無糖'], ice: ['正常', '少冰', '微冰', '去冰'] }, imageUrl: 'https://placehold.co/400x400/D7CCC8/3E2723?text=白玉歐蕾' },
    ],
};

// --- Custom Hooks ---
const useCountdown = (endDate) => {
    const [timeLeft, setTimeLeft] = React.useState({ days: 0, hours: 0, minutes: 0, seconds: 0 });
    const [isEnded, setIsEnded] = React.useState(false);
    React.useEffect(() => {
        if (!endDate) return;
        const calculateTimeLeft = () => {
            const difference = +new Date(endDate) - +new Date();
            if (difference > 0) return { days: Math.floor(difference / (1000 * 60 * 60 * 24)), hours: Math.floor((difference / (1000 * 60 * 60)) % 24), minutes: Math.floor((difference / 1000 / 60) % 60), seconds: Math.floor((difference / 1000) % 60) };
            return null;
        };
        const timer = setInterval(() => { const newTimeLeft = calculateTimeLeft(); if (newTimeLeft) { setTimeLeft(newTimeLeft); setIsEnded(false); } else { setIsEnded(true); clearInterval(timer); } }, 1000);
        const newTimeLeft = calculateTimeLeft();
        if (newTimeLeft) { setTimeLeft(newTimeLeft); setIsEnded(false); } else { setIsEnded(true); }
        return () => clearInterval(timer);
    }, [endDate]);
    return { timeLeft, isEnded };
};

// --- UI Components ---
const Toast = ({ message, type, onDismiss }) => {
    React.useEffect(() => {
        const timer = setTimeout(onDismiss, 3000);
        return () => clearTimeout(timer);
    }, [onDismiss]);

    const bgColor = { success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500' }[type] || 'bg-gray-800';
    const icon = { success: <CheckCircle />, error: <X />, info: <Info /> }[type];

    return (
        <div className={`fixed top-5 left-1/2 -translate-x-1/2 z-50 px-4 py-2 rounded-lg text-white font-semibold flex items-center space-x-2 shadow-lg animate-fade-in-down ${bgColor}`}>
            {icon}
            <span>{message}</span>
        </div>
    );
};

const AppHeader = ({ title, onBack, showBackButton, notifications, onMarkAllRead, onProfileClick }) => {
    const [panelOpen, setPanelOpen] = React.useState(false);
    const unreadCount = notifications.filter(n => !n.read).length;
    return (
        <header className="bg-white sticky top-0 z-20 border-b border-gray-200">
            <div className="px-4 h-14 flex items-center justify-between">
                <div className="w-1/4">
                    {showBackButton && (<button onClick={onBack} className="flex items-center text-blue-600"><ArrowLeft size={20} /><span className="ml-1 font-semibold">返回</span></button>)}
                </div>
                <h1 className="text-lg font-bold text-gray-900 w-1/2 text-center truncate">{title}</h1>
                <div className="w-1/4 flex justify-end items-center space-x-1">
                    <div className="relative">
                        <button onClick={() => setPanelOpen(!panelOpen)} className="relative p-2 rounded-full active:bg-gray-200 transition-colors">
                            <Bell className="w-6 h-6 text-gray-600" />
                            {unreadCount > 0 && <span className="absolute top-1 right-1 block h-2.5 w-2.5 rounded-full bg-red-500 border-2 border-white"></span>}
                        </button>
                        {panelOpen && <NotificationPanel notifications={notifications} onMarkAllRead={() => { onMarkAllRead(); setPanelOpen(false); }} />}
                    </div>
                   <button onClick={onProfileClick} className="p-2 rounded-full active:bg-gray-200 transition-colors">
                        <User className="w-6 h-6 text-gray-600" />
                    </button>
                </div>
            </div>
        </header>
    );
};

const NotificationPanel = ({ notifications, onMarkAllRead }) => {
    const getIconForType = type => ({ new_store: <Building className="w-5 h-5 text-green-500" />, offer: <Tag className="w-5 h-5 text-red-500" />, wishlist: <Gift className="w-5 h-5 text-yellow-500" /> }[type] || <Bell className="w-5 h-5 text-gray-500" />);
    return (<div className="absolute top-full right-0 mt-2 w-80 bg-white rounded-lg shadow-xl border border-gray-200 z-30 animate-fade-in-down"><div className="p-3 flex justify-between items-center border-b"><h3 className="font-bold">通知中心</h3><button onClick={onMarkAllRead} className="text-xs text-blue-600 font-semibold">全部已讀</button></div><div className="max-h-96 overflow-y-auto">{notifications.length > 0 ? notifications.map(notif => (<div key={notif.id} className={`p-3 flex items-start space-x-3 border-b ${!notif.read ? 'bg-blue-50' : 'bg-white'}`}><div className="flex-shrink-0 mt-1">{getIconForType(notif.type)}</div><div><p className="font-semibold text-sm">{notif.title}</p><p className="text-xs text-gray-600">{notif.content}</p><p className="text-xs text-gray-400 mt-1">{new Date(notif.timestamp?.toDate()).toLocaleString('zh-TW')}</p></div></div>)) : <p className="p-4 text-sm text-gray-500 text-center">沒有新的通知</p>}</div></div>);
};

const BottomNavBar = ({ activeTab, setActiveTab }) => {
    const navItems = [{ id: 'home', icon: Home, label: '主頁' }, { id: 'groupbuy', icon: ShoppingBag, label: '拼團' }, { id: 'tea', icon: Coffee, label: '下午茶' }, { id: 'wishlist', icon: Gift, label: '許願池' }];
    return (<footer className="bg-white/95 backdrop-blur-sm absolute bottom-0 left-0 right-0 z-20 border-t border-gray-200/80"><div className="flex justify-around items-center h-16">{navItems.map(item => (<button key={item.id} onClick={() => setActiveTab(item.id)} className={`flex flex-col items-center justify-center space-y-1 w-full transition-colors ${activeTab === item.id ? 'text-blue-600' : 'text-gray-500 hover:text-blue-600'}`}><item.icon className="w-6 h-6" /><span className="text-xs font-medium">{item.label}</span></button>))}</div></footer>);
};

const StoreCard = ({ store, onSelect, isFavorite, onToggleFavorite, small = false }) => (
  <div className={`bg-white rounded-xl overflow-hidden transform active:scale-95 transition-transform duration-150 relative ${small ? 'w-48 border border-gray-100' : 'shadow-sm'}`} onClick={() => onSelect(store)}>
    <div className={`flex ${small ? 'flex-col' : 'p-3'}`}>
      <img src={store.logo} alt={`${store.name} logo`} className={`${small ? 'w-full h-24' : 'w-20 h-20 rounded-lg'} flex-shrink-0 object-cover`} />
      <div className={`${small ? 'p-2' : 'ml-4'} flex flex-col justify-center`}>
        <div>{!small && <span className="inline-block bg-gray-100 text-gray-800 text-xs font-semibold px-2 py-1 rounded-full mb-1">{store.category}</span>}<h3 className={`font-bold text-gray-900 ${small ? 'text-sm' : ''}`}>{store.name}</h3></div>
        <p className={`text-gray-600 mt-1 line-clamp-2 ${small ? 'text-xs' : 'text-sm'}`}>{store.offer}</p>
      </div>
    </div>
    <button onClick={(e) => { e.stopPropagation(); onToggleFavorite(store.id); }} className="absolute top-3 right-3 p-1.5 z-10"><Heart className={`w-6 h-6 transition-all ${isFavorite ? 'text-red-500 fill-current' : 'text-gray-300'}`} /></button>
  </div>
);

// --- Page Components ---

const HomeScreen = ({ stores, currentUser, onToggleFavorite, onSelectStore }) => {
    const [searchTerm, setSearchTerm] = React.useState('');
    const [selectedCategory, setSelectedCategory] = React.useState('所有類別');
    const favorites = currentUser?.favorites || [];

    const recommendedStores = React.useMemo(() => {
        const favoriteCategories = new Set(stores.filter(s => favorites.includes(s.id)).map(s => s.category));
        return stores.filter(s => favoriteCategories.has(s.category) && !favorites.includes(s.id)).slice(0, 5);
    }, [stores, favorites]);

    const filteredStores = React.useMemo(() => {
        let filtered = stores;
        if (selectedCategory === '我的最愛') filtered = stores.filter(store => favorites.includes(store.id));
        else if (selectedCategory !== '所有類別') filtered = stores.filter(store => store.category === selectedCategory);
        return filtered.filter(store => store.name.toLowerCase().includes(searchTerm.toLowerCase()));
    }, [searchTerm, selectedCategory, favorites, stores]);

    const CategoryFilter = ({ selected, onSelect }) => {
        const allCategories = ['我的最愛', '所有類別', ...[...new Set(stores.map(s => s.category))]];
        return (<div className="flex items-center space-x-2 overflow-x-auto pb-2 -mx-4 px-4">{allCategories.map(cat => (<button key={cat} onClick={() => onSelect(cat)} className={`px-4 py-2 rounded-full text-sm font-semibold whitespace-nowrap transition-colors ${selected === cat ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700'}`}>{cat === '我的最愛' && <Heart className="w-4 h-4 inline-block mr-1" />}{cat}</button>))}</div>);
    };

    return (<main className="p-4 space-y-4"><div className="relative"><Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" size={20} /><input type="text" placeholder="搜尋商店名稱..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full h-11 pl-10 pr-4 bg-gray-100 border-transparent rounded-lg focus:ring-2 focus:ring-blue-500" /></div>{recommendedStores.length > 0 && (<div><h2 className="font-bold text-gray-800 mb-2">為您推薦</h2><div className="flex space-x-4 overflow-x-auto pb-2 -mx-4 px-4">{recommendedStores.map(store => <StoreCard key={store.id} store={store} onSelect={onSelectStore} isFavorite={favorites.includes(store.id)} onToggleFavorite={onToggleFavorite} small />)}</div></div>)}<CategoryFilter selected={selectedCategory} onSelect={setSelectedCategory} /><div className="space-y-3">{filteredStores.length > 0 ? filteredStores.map(store => <StoreCard key={store.id} store={store} onSelect={onSelectStore} isFavorite={favorites.includes(store.id)} onToggleFavorite={onToggleFavorite} />) : <div className="text-center py-16"><p className="text-gray-500">找不到符合條件的商店。</p></div>}</div></main>);
};

const WishlistScreen = ({ wishlist, currentUser, allUsers, onWish, onAddWish, setView, onSendMessage }) => {
    const [isAddModalOpen, setIsAddModalOpen] = React.useState(false);
    const [selectedCategory, setSelectedCategory] = React.useState('所有');

    const wishCategories = ['所有', '店家', '禮物', '旅遊', '生活'];

    const filteredWishes = React.useMemo(() => {
        if (selectedCategory === '所有') return wishlist;
        return wishlist.filter(wish => wish.category === selectedCategory);
    }, [wishlist, selectedCategory]);

    const getUserInfo = (userId) => {
        const user = allUsers.find(u => u.id === userId);
        return user || { name: '匿名', avatarUrl: 'https://placehold.co/100x100/CCCCCC/FFFFFF?text=?' };
    };

    return (
        <main className="p-4">
            <div className="flex items-center space-x-2 overflow-x-auto pb-4">
                {wishCategories.map(cat => (
                    <button key={cat} onClick={() => setSelectedCategory(cat)} className={`px-4 py-2 rounded-full text-sm font-semibold whitespace-nowrap transition-colors ${selectedCategory === cat ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700'}`}>{cat}</button>
                ))}
            </div>
            <div className="space-y-3">
                {filteredWishes.length > 0 ? filteredWishes.map(wish => (
                    <WishCard key={wish.id} wish={wish} currentUser={currentUser} onWish={onWish} creator={getUserInfo(wish.creatorId)} onSelect={() => setView({ name: 'wishDetail', params: { wishId: wish.id } })} onSendMessage={onSendMessage} />
                )) : <p className="text-center text-gray-500 py-16">這個分類還沒有願望喔！</p>}
            </div>
            <button onClick={() => setIsAddModalOpen(true)} className="fixed bottom-20 right-4 bg-green-500 text-white rounded-full shadow-lg p-4 flex items-center justify-center animate-bounce">
                <PlusCircle size={28} />
            </button>
            {isAddModalOpen && <AddWishModal onClose={() => setIsAddModalOpen(false)} onAddWish={onAddWish} currentUser={currentUser} />}
        </main>
    );
};

const WishCard = ({ wish, currentUser, onWish, creator, onSelect, onSendMessage }) => {
    const categoryInfo = {
        '店家': { icon: <Building2 className="text-orange-500" />, color: 'bg-orange-100 text-orange-700' },
        '禮物': { icon: <Gift className="text-pink-500" />, color: 'bg-pink-100 text-pink-700' },
        '旅遊': { icon: <Plane className="text-cyan-500" />, color: 'bg-cyan-100 text-cyan-700' },
        '生活': { icon: <Heart className="text-red-500" />, color: 'bg-red-100 text-red-700' },
    }[wish.category] || { icon: <Star />, color: 'bg-gray-100 text-gray-700' };

    const hasWished = wish.wishedBy.includes(currentUser.id);

    return (
        <div className="bg-white rounded-xl border border-gray-200 p-4 space-y-3 transition-colors active:bg-gray-50" onClick={onSelect}>
            <div className="flex items-center justify-between">
                <div className="flex items-center space-x-2">
                    <img src={creator.avatarUrl} alt={creator.name} className="w-8 h-8 rounded-full" />
                    <div>
                        <p className="font-semibold text-sm">{creator.name}</p>
                        <p className="text-xs text-gray-400">{formatRelativeTime(wish.createdAt?.toDate())}</p>
                    </div>
                </div>
                <div className={`flex items-center space-x-1 text-xs font-semibold px-2 py-1 rounded-full ${categoryInfo.color}`}>
                    {categoryInfo.icon}
                    <span>{wish.category}</span>
                </div>
            </div>
            <p className="text-gray-800">{wish.text}</p>
            <div className="flex items-center justify-between text-sm text-gray-500 border-t pt-3 mt-2">
                 <div className="flex items-center gap-4">
                    <button 
                        onClick={(e) => { e.stopPropagation(); onWish(wish.id); }} 
                        className={`flex items-center gap-1.5 transition-colors ${hasWished ? 'text-blue-600 font-semibold' : 'text-gray-500 hover:text-blue-600'}`}
                    >
                        <ThumbsUp size={16} className={hasWished ? 'fill-current' : ''} /> 
                        <span>{wish.wishes}</span>
                    </button>
                    <button 
                        className="flex items-center gap-1.5 text-gray-500 hover:text-blue-600"
                        onClick={(e) => { e.stopPropagation(); onSelect(); }}
                    >
                        <MessageCircle size={16} /> 
                        <span>{wish.commentCount || 0}</span>
                    </button>
                </div>
                 {currentUser.id !== creator.id && (
                    <button onClick={(e) => { e.stopPropagation(); onSendMessage(creator, wish.id); }} className="px-4 py-2 rounded-full font-bold flex items-center gap-2 transition-colors bg-blue-500 text-white text-xs active:bg-blue-600">
                        <Send size={14} />
                        傳送私訊
                    </button>
                )}
            </div>
        </div>
    );
};

const AddWishModal = ({ onClose, onAddWish, currentUser }) => {
    const [category, setCategory] = React.useState('店家');
    const [text, setText] = React.useState('');
    const wishCategories = ['店家', '禮物', '旅遊', '生活'];

    const handleSubmit = () => {
        if (text.trim().length < 5) {
            alert("願望內容請至少輸入 5 個字喔！");
            return;
        }
        onAddWish({
            text: text.trim(),
            category,
            creatorId: currentUser.id,
            wishes: 1,
            wishedBy: [currentUser.id],
            createdAt: serverTimestamp(),
            commentCount: 0
        });
        onClose();
    };

    return (
        <div className="absolute inset-0 bg-black/60 z-50 flex justify-center items-center p-4" onClick={onClose}>
            <div className="bg-white rounded-2xl w-full max-w-sm animate-fade-in-up" onClick={e => e.stopPropagation()}>
                <h3 className="text-lg font-bold text-center p-4 border-b">許下您的願望</h3>
                <div className="p-4 space-y-4">
                    <div>
                        <label className="font-semibold text-sm mb-2 block">選擇分類</label>
                        <div className="flex flex-wrap gap-2">
                            {wishCategories.map(cat => (
                                <button key={cat} onClick={() => setCategory(cat)} className={`px-3 py-1.5 rounded-full text-sm font-semibold ${category === cat ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-800'}`}>{cat}</button>
                            ))}
                        </div>
                    </div>
                    <div>
                        <label className="font-semibold text-sm mb-2 block">願望內容</label>
                        <textarea value={text} onChange={e => setText(e.target.value)} placeholder="詳細描述您的願望..." rows="4" className="w-full p-2 bg-gray-100 rounded-lg border-transparent focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                </div>
                <div className="p-4 border-t">
                    <button onClick={handleSubmit} className="w-full bg-green-500 text-white font-bold py-3 rounded-lg">送出願望</button>
                </div>
            </div>
        </div>
    );
};

const ProfileScreen = ({ currentUser, onCheckIn, canCheckIn, setView }) => (
    <main className="p-4 space-y-4">
        <button onClick={() => setView({ name: 'editProfile' })} className="w-full flex items-start space-x-4 text-left active:bg-gray-100 rounded-lg p-2 -m-2 transition-colors">
            <img src={currentUser.avatarUrl} alt="Employee Avatar" className="w-20 h-20 rounded-full" />
            <div className="pt-2">
                <div className="flex items-center space-x-2">
                    <h2 className="text-2xl font-bold">{currentUser.nickname || currentUser.name}</h2>
                    {currentUser.status === 'pending_verification' && (
                        <span className="bg-yellow-100 text-yellow-800 text-xs font-semibold px-2.5 py-1 rounded-full">
                            未激活
                        </span>
                    )}
                </div>
                <p className="text-gray-600">{MOCK_COMPANIES[currentUser.companyId]?.name || '未知公司'}</p>
            </div>
        </button>
         {currentUser.status === 'pending_verification' && (
            <div className="bg-yellow-50 border border-yellow-200 text-yellow-800 text-sm rounded-lg p-4 text-center">
                <p>您的帳號正在等待公司管理員審核。審核通過後將解鎖所有功能，並移除「未激活」標記。</p>
            </div>
        )}
        <div className="bg-gradient-to-r from-blue-600 to-blue-800 text-white rounded-xl shadow-lg p-5">
            <div className="flex justify-between items-center">
                <span className="text-sm opacity-80">福利錢包餘額</span>
                <Wallet className="w-6 h-6 opacity-80" />
            </div>
            <div className="mt-2 text-4xl font-bold tracking-wider">NT$ {currentUser.walletBalance.toLocaleString()}</div>
            <div className="mt-4 flex space-x-4 text-sm">
                <button onClick={() => setView({ name: 'transactions' })} className="bg-white/20 hover:bg-white/30 w-full py-2 rounded-lg font-semibold">交易紀錄</button>
                <button className="bg-white/20 hover:bg-white/30 w-full py-2 rounded-lg font-semibold">儲值</button>
            </div>
        </div>

        <div className="bg-white rounded-xl border border-gray-200 overflow-hidden">
             <button onClick={() => setView({ name: 'idCard' })} className="w-full text-left p-4 flex justify-between items-center active:bg-gray-100 transition-colors">
                <div className="flex items-center space-x-3">
                    <Badge className="w-6 h-6 text-blue-500" />
                    <span className="font-semibold">我的員工證</span>
                </div>
                <ChevronRight className="w-5 h-5 text-gray-400" />
            </button>
            <button onClick={() => setView({ name: 'points' })} className="w-full text-left p-4 flex justify-between items-center active:bg-gray-100 transition-colors border-t border-gray-200">
                <div className="flex items-center space-x-3">
                    <Award className="w-6 h-6 text-blue-500" />
                    <span className="font-semibold">我的點數</span>
                </div>
                <div className="flex items-center">
                    <span className="font-bold text-lg text-blue-800">{currentUser.points} 點</span>
                    <ChevronRight className="w-5 h-5 text-gray-400 ml-2" />
                </div>
            </button>
            <div className="border-t border-gray-200 p-4">
                <button onClick={onCheckIn} disabled={!canCheckIn} className={`font-bold py-3 rounded-lg w-full flex items-center justify-center space-x-2 transition-colors ${canCheckIn ? 'bg-green-500 text-white active:bg-green-600' : 'bg-gray-200 text-gray-500'}`}>
                    <CheckCircle />
                    <span>{canCheckIn ? '每日簽到 (+10點)' : '今日已簽到'}</span>
                </button>
            </div>
        </div>
        {currentUser.role === 'admin' && (
             <button onClick={() => setView({ name: 'admin' })} className="bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg w-full active:bg-indigo-700 flex items-center justify-center space-x-2">
                <ShieldCheck size={20} />
                <span>管理員後台</span>
            </button>
        )}
        <button onClick={() => signOut(auth)} className="bg-red-500 text-white font-bold py-3 px-6 rounded-lg w-full active:bg-red-600 flex items-center justify-center space-x-2">
            <LogOut size={20} />
            <span>登出</span>
        </button>
    </main>
);

const TransactionHistoryScreen = ({ transactions }) => {
    const getTransactionIcon = (type) => {
        switch (type) {
            case 'purchase': return <ShoppingCart className="w-6 h-6 text-red-500" />;
            case 'topup': return <Wallet className="w-6 h-6 text-green-500" />;
            case 'groupbuy_refund': return <Users className="w-6 h-6 text-blue-500" />;
            default: return <Clock className="w-6 h-6 text-gray-500" />;
        }
    };

    const formatTimestamp = (timestamp) => {
        if (!timestamp?.toDate) return '...';
        return timestamp.toDate().toLocaleString('zh-TW');
    };

    return (
        <main className="p-4">
            {transactions.length > 0 ? (
                <ul className="bg-white rounded-xl border border-gray-200 divide-y divide-gray-200">
                    {transactions.map(tx => (
                        <li key={tx.id} className="p-4 flex items-center justify-between">
                            <div className="flex items-center space-x-4">
                                {getTransactionIcon(tx.type)}
                                <div>
                                    <p className="font-semibold text-gray-800">{tx.description}</p>
                                    <p className="text-sm text-gray-500">{formatTimestamp(tx.timestamp)}</p>
                                </div>
                            </div>
                            <p className={`font-bold text-lg ${tx.amount > 0 ? 'text-green-600' : 'text-gray-800'}`}>
                                {tx.amount > 0 ? `+${tx.amount.toLocaleString()}` : tx.amount.toLocaleString()}
                            </p>
                        </li>
                    ))}
                </ul>
            ) : (
                <div className="text-center py-20">
                    <p className="text-gray-500">目前沒有任何交易紀錄。</p>
                </div>
            )}
        </main>
    );
};

const PointHistoryScreen = ({ pointsHistory }) => {
    const getPointIcon = (type) => {
        switch (type) {
            case 'checkin': return <CheckCircle className="w-6 h-6 text-green-500" />;
            case 'special_event': return <Gift className="w-6 h-6 text-yellow-500" />;
            default: return <Award className="w-6 h-6 text-blue-500" />;
        }
    };

    const formatTimestamp = (timestamp) => {
        if (!timestamp?.toDate) return '...';
        return timestamp.toDate().toLocaleString('zh-TW');
    };

    return (
        <main className="p-4">
            {pointsHistory.length > 0 ? (
                <ul className="bg-white rounded-xl border border-gray-200 divide-y divide-gray-200">
                    {pointsHistory.map(ph => (
                        <li key={ph.id} className="p-4 flex items-center justify-between">
                            <div className="flex items-center space-x-4">
                                {getPointIcon(ph.type)}
                                <div>
                                    <p className="font-semibold text-gray-800">{ph.description}</p>
                                    <p className="text-sm text-gray-500">{formatTimestamp(ph.timestamp)}</p>
                                </div>
                            </div>
                            <p className="font-bold text-lg text-green-600">
                                +{ph.points}
                            </p>
                        </li>
                    ))}
                </ul>
            ) : (
                <div className="text-center py-20">
                    <p className="text-gray-500">目前沒有任何點數紀錄。</p>
                </div>
            )}
        </main>
    );
};

const GroupBuyCard = ({ item, onSelect }) => {
    const { timeLeft, isEnded } = useCountdown(item.endDate);

    const timerString = () => {
        if (isEnded) return "已結束";
        const days = timeLeft.days > 0 ? `${timeLeft.days} 天 ` : '';
        const hours = `${String(timeLeft.hours).padStart(2, '0')}`;
        const minutes = `${String(timeLeft.minutes).padStart(2, '0')}`;
        const seconds = `${String(timeLeft.seconds).padStart(2, '0')}`;
        return `剩餘 ${days}${hours}:${minutes}:${seconds}`;
    };

    return (
        <div className={`bg-white rounded-xl border border-gray-200 overflow-hidden transition-all duration-150 ${isEnded ? 'opacity-50' : 'active:scale-95'}`} onClick={() => !isEnded && onSelect(item)}>
            <img src={item.imageUrl} alt={item.name} className="w-full h-40 object-cover" />
            <div className="p-4">
                <h3 className="font-bold text-lg truncate">{item.name}</h3>
                <div className="flex items-baseline space-x-2 mt-1">
                    <span className="text-sm font-semibold text-red-500 bg-red-100 px-2 py-1 rounded">{item.groupSize}人成團</span>
                    <p className="text-2xl font-bold text-red-500">NT${item.groupPrice}</p>
                </div>
                <p className="text-sm text-gray-500 line-through mt-1">單獨購買 NT${item.marketPrice}</p>
                <div className="mt-2 flex flex-wrap gap-1">
                    {item.tags?.map(tag => (
                        <span key={tag} className="text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full font-medium">{tag}</span>
                    ))}
                </div>
                 <div className={`mt-2 flex items-center text-sm ${isEnded ? 'text-gray-500' : 'text-orange-600'}`}>
                    <Clock size={16} className="mr-1.5" />
                    <span className="font-semibold">{timerString()}</span>
                </div>
            </div>
        </div>
    );
};

const GroupBuyScreen = ({ groupBuys, onSelect }) => {
    const [searchTerm, setSearchTerm] = React.useState('');
    const [selectedTag, setSelectedTag] = React.useState('所有');

    const allTags = React.useMemo(() => {
        const tags = new Set();
        groupBuys.forEach(item => {
            item.tags?.forEach(tag => tags.add(tag));
        });
        return ['所有', ...Array.from(tags)];
    }, [groupBuys]);

    const filteredGroupBuys = React.useMemo(() => {
        return groupBuys.filter(item => {
            const tagMatch = selectedTag === '所有' || item.tags?.includes(selectedTag);
            const searchMatch = item.name.toLowerCase().includes(searchTerm.toLowerCase());
            return tagMatch && searchMatch;
        });
    }, [groupBuys, searchTerm, selectedTag]);

    const now = new Date();
    const activeGroupBuys = filteredGroupBuys.filter(item => new Date(item.endDate) > now);
    const endedGroupBuys = filteredGroupBuys.filter(item => new Date(item.endDate) <= now);

    const TagFilter = () => (
        <div className="flex items-center space-x-2 overflow-x-auto pb-2">
            {allTags.map(tag => (
                <button 
                    key={tag} 
                    onClick={() => setSelectedTag(tag)} 
                    className={`px-3 py-1.5 rounded-full text-sm font-semibold whitespace-nowrap transition-colors ${selectedTag === tag ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700'}`}
                >
                    {tag}
                </button>
            ))}
        </div>
    );

    return (
        <main className="p-4 space-y-4">
            <div className="relative">
                <Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" size={20} />
                <input 
                    type="text" 
                    placeholder="搜尋拼團活動..." 
                    value={searchTerm} 
                    onChange={(e) => setSearchTerm(e.target.value)} 
                    className="w-full h-11 pl-10 pr-4 bg-gray-100 border-transparent rounded-lg focus:ring-2 focus:ring-blue-500" 
                />
            </div>
            <TagFilter />
            {activeGroupBuys.length > 0 ? (
                activeGroupBuys.map(item => <GroupBuyCard key={item.id} item={item} onSelect={onSelect} />)
            ) : (
                <div className="text-center py-16">
                    <p className="text-gray-500">找不到符合條件的拼團活動。</p>
                </div>
            )}
            {endedGroupBuys.length > 0 && (
                <div>
                    <h3 className="text-sm font-bold text-gray-500 my-4 text-center">--- 已結束的活動 ---</h3>
                    <div className="space-y-4">
                       {endedGroupBuys.map(item => <GroupBuyCard key={item.id} item={item} onSelect={onSelect} />)}
                    </div>
                </div>
            )}
        </main>
    );
};

const AfternoonTeaScreen = ({ teaStores, onSelectStore }) => (<main className="p-4 space-y-3">{teaStores.map(store => (<div key={store.id} onClick={() => onSelectStore(store)} className="bg-white rounded-xl border border-gray-200 p-4 flex items-center space-x-4 active:bg-gray-100 transition-colors cursor-pointer"><img src={store.logo} alt={store.name} className="w-16 h-16 rounded-lg" /><div><h3 className="font-bold text-lg">{store.name}</h3><p className="text-sm text-gray-500">{store.description}</p></div></div>))}</main>);

const TeaOrderScreen = ({ store, menu, onAddToCart }) => {
    const [selectedItem, setSelectedItem] = React.useState(null);

    const handleAddToCart = (item, options, quantity) => {
        onAddToCart({ ...item, options, quantity });
        setSelectedItem(null);
    };

    return (
        <main>
            <div className="p-4 flex items-center space-x-4 bg-white border-b">
                <img src={store.logo} alt={store.name} className="w-16 h-16 rounded-lg shadow-sm" />
                <div>
                    <h2 className="text-2xl font-bold">{store.name}</h2>
                    <p className="text-gray-500">{store.description}</p>
                </div>
            </div>
            <div className="p-4 grid grid-cols-1 md:grid-cols-2 gap-3">
                {menu.map(item => (
                    <div key={item.id} className="bg-white rounded-xl border border-gray-200 p-3 flex items-center space-x-3">
                        <img src={item.imageUrl} alt={item.name} className="w-20 h-20 rounded-lg object-cover" />
                        <div className="flex-grow">
                            <p className="font-semibold">{item.name}</p>
                            <p className="text-sm text-gray-500">NT$ {item.price}</p>
                        </div>
                        <button onClick={() => setSelectedItem(item)} className="p-2 rounded-full bg-blue-500 text-white active:bg-blue-600 shadow-md">
                            <Plus size={20} />
                        </button>
                    </div>
                ))}
            </div>
            {selectedItem && (
                <OptionSelector 
                    item={selectedItem} 
                    onClose={() => setSelectedItem(null)} 
                    onAddToCart={handleAddToCart} 
                />
            )}
        </main>
    );
};

const OptionSelector = ({ item, onClose, onAddToCart }) => {
    const [options, setOptions] = React.useState({});
    const [quantity, setQuantity] = React.useState(1);

    React.useEffect(() => {
        const defaultOptions = {};
        if (item.options) {
            Object.keys(item.options).forEach(key => {
                defaultOptions[key] = item.options[key][0];
            });
        }
        setOptions(defaultOptions);
    }, [item]);

    const totalPrice = React.useMemo(() => item.price * quantity, [item.price, quantity]);

    const handleSubmit = () => {
        onAddToCart(item, options, quantity);
    };

    return (
        <div className="absolute inset-0 bg-black/60 z-50 flex justify-center items-end" onClick={onClose}>
            <div 
                className="bg-white rounded-t-2xl w-full max-w-md animate-slide-in-up" 
                onClick={e => e.stopPropagation()}
            >
                <div className="p-4 border-b text-center relative">
                    <h3 className="font-bold text-lg">{item.name}</h3>
                    <button onClick={onClose} className="absolute top-1/2 -translate-y-1/2 right-4 p-1 rounded-full active:bg-gray-200"><X size={20}/></button>
                </div>
                <div className="p-4 space-y-4 max-h-[50vh] overflow-y-auto">
                    {item.options && Object.entries(item.options).map(([key, values]) => (
                        <div key={key}>
                            <h4 className="font-semibold capitalize mb-2 text-gray-800">{key === 'sugar' ? '甜度' : '冰塊'}</h4>
                            <div className="flex flex-wrap gap-2">
                                {values.map(value => (
                                    <button 
                                        key={value} 
                                        onClick={() => setOptions({...options, [key]: value})} 
                                        className={`px-4 py-2 rounded-full text-sm font-semibold transition-colors ${options[key] === value ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-800'}`}
                                    >
                                        {value}
                                    </button>
                                ))}
                            </div>
                        </div>
                    ))}
                </div>
                <div className="p-4 border-t flex items-center justify-between">
                     <div className="flex items-center space-x-3">
                        <button onClick={() => setQuantity(q => Math.max(1, q - 1))} className="p-2 rounded-full bg-gray-200 active:bg-gray-300"><Minus size={16} /></button>
                        <span className="font-bold text-lg w-8 text-center">{quantity}</span>
                        <button onClick={() => setQuantity(q => q + 1)} className="p-2 rounded-full bg-gray-200 active:bg-gray-300"><Plus size={16} /></button>
                    </div>
                    <button onClick={handleSubmit} className="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg w-1/2">
                        加入 - NT$ {totalPrice}
                    </button>
                </div>
            </div>
        </div>
    );
};

const CartModal = ({ cart, setCart, user, onCheckout, onClose }) => {
    const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    
    const handleRemoveItem = (cartId) => {
        setCart(currentCart => currentCart.filter(item => item.cartId !== cartId));
    };

    return (
        <div className="absolute inset-0 bg-black/60 z-50 flex justify-center items-end animate-fade-in" onClick={onClose}>
            <div className="bg-white rounded-t-2xl w-full max-w-lg animate-slide-in-up" onClick={e => e.stopPropagation()}>
                <div className="p-4 border-b text-center relative">
                    <h2 className="font-bold text-lg">您的訂單</h2>
                    <button onClick={onClose} className="absolute top-1/2 -translate-y-1/2 right-4"><X /></button>
                </div>
                <div className="p-4 max-h-60 overflow-y-auto">
                    {cart.length > 0 ? cart.map((item) => (
                        <div key={item.cartId} className="flex items-center justify-between py-2">
                            <div>
                                <p className="font-semibold">{item.name} <span className="font-normal text-gray-600">x{item.quantity}</span></p>
                                <p className="text-sm text-gray-500">{Object.values(item.options).join(', ')}</p>
                            </div>
                            <div className="flex items-center space-x-3">
                                <p>NT$ {item.price * item.quantity}</p>
                                <button onClick={() => handleRemoveItem(item.cartId)} className="text-red-500 p-1"><X size={16} /></button>
                            </div>
                        </div>
                    )) : <p className="text-center text-gray-500 py-4">您的購物車是空的</p>}
                </div>
                <div className="p-4 border-t space-y-3">
                    <div className="flex justify-between font-semibold"><span>福利錢包餘額</span><span>NT$ {user.walletBalance}</span></div>
                    <div className="flex justify-between font-bold text-xl"><span>總計</span><span>NT$ {total}</span></div>
                    <button onClick={() => onCheckout(total)} disabled={user.walletBalance < total || cart.length === 0} className="w-full bg-blue-600 text-white font-bold py-3 rounded-lg disabled:bg-gray-400">
                        {user.walletBalance >= total ? '確認付款' : '餘額不足'}
                    </button>
                </div>
            </div>
        </div>
    );
};

const AuthScreen = () => {
    const [isLogin, setIsLogin] = React.useState(true);
    const [email, setEmail] = React.useState('');
    const [password, setPassword] = React.useState('');
    const [error, setError] = React.useState('');
    const [isLoading, setIsLoading] = React.useState(false);

    const handleAuthAction = async (e) => {
        e.preventDefault();
        setIsLoading(true);
        setError('');
        try {
            if (isLogin) {
                await signInWithEmailAndPassword(auth, email, password);
            } else {
                await createUserWithEmailAndPassword(auth, email, password);
            }
        } catch (err) {
            setError(translateAuthError(err.code));
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div className="flex flex-col items-center justify-center h-full p-8 bg-gray-50">
            <h1 className="text-3xl font-bold text-blue-600 mb-2">企業福利平台</h1>
            <p className="text-gray-500 mb-8">{isLogin ? '登入您的帳戶' : '建立一個新帳戶'}</p>
            <form onSubmit={handleAuthAction} className="w-full space-y-4">
                <input type="email" value={email} onChange={(e) => setEmail(e.target.value)} placeholder="電子郵件" className="w-full h-12 px-4 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required />
                <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} placeholder="密碼" className="w-full h-12 px-4 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required />
                {error && <p className="text-red-500 text-sm text-center">{error}</p>}
                <button type="submit" disabled={isLoading} className="w-full bg-blue-600 text-white font-bold py-3 rounded-lg active:bg-blue-700 disabled:bg-gray-400 flex items-center justify-center">
                    {isLoading && <Loader2 className="w-5 h-5 mr-2 animate-spin" />}
                    {isLogin ? '登入' : '註冊'}
                </button>
            </form>
            <button onClick={() => setIsLogin(!isLogin)} className="mt-4 text-sm text-blue-600 hover:underline">
                {isLogin ? '還沒有帳戶嗎？註冊一個' : '已經有帳戶了？直接登入'}
            </button>
        </div>
    );
};

const RegistrationScreen = ({ firebaseUser, onRegistrationComplete }) => {
    const [name, setName] = React.useState('');
    const [phone, setPhone] = React.useState('');
    const [companyId, setCompanyId] = React.useState('');
    const [companySearch, setCompanySearch] = React.useState('');
    const [companySuggestions, setCompanySuggestions] = React.useState([]);
    const [isLoading, setIsLoading] = React.useState(false);
    const [error, setError] = React.useState('');

    const handleCompanySearch = (e) => {
        const query = e.target.value;
        setCompanySearch(query);
        setCompanyId('');
        if (query.length > 0) {
            const suggestions = Object.values(MOCK_COMPANIES).filter(c => c.name.toLowerCase().includes(query.toLowerCase()));
            setCompanySuggestions(suggestions);
        } else {
            setCompanySuggestions([]);
        }
    };

    const selectCompany = (company) => {
        setCompanyId(company.id);
        setCompanySearch(company.name);
        setCompanySuggestions([]);
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        if (!name.trim() || !phone.trim() || !companyId) {
            setError('所有欄位皆為必填，且需從列表中選擇一間公司');
            return;
        }
        setIsLoading(true);
        setError('');

        const avatarChar = name.trim()[0] || ' ';
        const newUserProfile = {
            name: name.trim(),
            nickname: '',
            phone: phone.trim(),
            companyId,
            email: firebaseUser.email,
            avatarUrl: `https://placehold.co/100x100/CCCCCC/FFFFFF?text=${encodeURIComponent(avatarChar)}`,
            favorites: [],
            points: 100,
            lastCheckIn: '',
            walletBalance: 0,
            status: 'pending_verification',
            idCardUrl: '',
            role: 'user', // Default role
        };

        try {
            await setDoc(doc(db, "users", firebaseUser.uid), newUserProfile);
            onRegistrationComplete({ id: firebaseUser.uid, ...newUserProfile });
        } catch (err) {
            console.error("Error writing user profile: ", err);
            setError("儲存資料失敗，請稍後再試。");
            setIsLoading(false);
        }
    };

    return (
        <div className="flex flex-col h-full p-8 bg-gray-50">
            <h1 className="text-3xl font-bold text-blue-600 mb-2">建立個人檔案</h1>
            <p className="text-gray-500 mb-8">只差一步！請完成您的個人資料。</p>
            <form onSubmit={handleSubmit} className="w-full space-y-4 flex-grow flex flex-col">
                <div className="space-y-4">
                    <input type="text" value={name} onChange={(e) => setName(e.target.value)} placeholder="姓名" className="w-full h-12 px-4 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required />
                    <input type="tel" value={phone} onChange={(e) => setPhone(e.target.value)} placeholder="電話號碼" className="w-full h-12 px-4 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required />
                    <div className="relative">
                        <input type="text" value={companySearch} onChange={handleCompanySearch} placeholder="輸入公司名稱搜尋" className="w-full h-12 px-4 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required />
                        {companySuggestions.length > 0 && (
                            <ul className="absolute top-full mt-1 w-full bg-white border rounded-lg shadow-lg max-h-40 overflow-y-auto z-10">
                                {companySuggestions.map(c => (
                                    <li key={c.id} onClick={() => selectCompany(c)} className="p-3 hover:bg-gray-100 cursor-pointer text-sm">{c.name}</li>
                                ))}
                            </ul>
                        )}
                    </div>
                </div>
                {error && <p className="text-red-500 text-sm text-center">{error}</p>}
                <div className="mt-auto">
                    <button type="submit" disabled={isLoading} className="w-full bg-blue-600 text-white font-bold py-3 rounded-lg active:bg-blue-700 disabled:bg-gray-400 flex items-center justify-center">
                        {isLoading && <Loader2 className="w-5 h-5 mr-2 animate-spin" />}
                        完成註冊
                    </button>
                </div>
            </form>
        </div>
    );
};

const EditProfileScreen = ({ currentUser, onSave }) => {
    const [name, setName] = React.useState(currentUser.name);
    const [nickname, setNickname] = React.useState(currentUser.nickname || '');
    const [phone, setPhone] = React.useState(currentUser.phone);
    const [isLoading, setIsLoading] = React.useState(false);

    const handleSave = async () => {
        setIsLoading(true);
        await onSave({ name, nickname, phone });
        setIsLoading(false);
    };

    return (
        <main className="p-4 space-y-6">
            <div className="flex flex-col items-center space-y-4">
                <div className="relative">
                    <img src={currentUser.avatarUrl} alt="Avatar" className="w-24 h-24 rounded-full" />
                    <button className="absolute -bottom-1 -right-1 bg-blue-600 p-2 rounded-full border-2 border-white">
                        <Camera className="w-4 h-4 text-white" />
                    </button>
                </div>
            </div>
            <div className="space-y-4">
                <div>
                    <label className="text-sm font-medium text-gray-700">姓名</label>
                    <input type="text" value={name} onChange={(e) => setName(e.target.value)} className="w-full h-12 px-4 mt-1 bg-gray-100 border-transparent rounded-lg focus:ring-2 focus:ring-blue-500" />
                </div>
                <div>
                    <label className="text-sm font-medium text-gray-700">暱稱</label>
                    <input type="text" value={nickname} onChange={(e) => setNickname(e.target.value)} placeholder="新增您的暱稱" className="w-full h-12 px-4 mt-1 bg-gray-100 border-transparent rounded-lg focus:ring-2 focus:ring-blue-500" />
                </div>
                <div>
                    <label className="text-sm font-medium text-gray-700">電話</label>
                    <input type="tel" value={phone} onChange={(e) => setPhone(e.target.value)} className="w-full h-12 px-4 mt-1 bg-gray-100 border-transparent rounded-lg focus:ring-2 focus:ring-blue-500" />
                </div>
                 <div>
                    <label className="text-sm font-medium text-gray-700">電子郵箱</label>
                    <input type="email" value={currentUser.email} disabled className="w-full h-12 px-4 mt-1 bg-gray-200 border-transparent rounded-lg text-gray-500" />
                </div>
                 <div>
                    <label className="text-sm font-medium text-gray-700">公司</label>
                    <input type="text" value={MOCK_COMPANIES[currentUser.companyId]?.name || '未知公司'} disabled className="w-full h-12 px-4 mt-1 bg-gray-200 border-transparent rounded-lg text-gray-500" />
                </div>
            </div>
            <button onClick={handleSave} disabled={isLoading} className="w-full bg-blue-600 text-white font-bold py-3 rounded-lg active:bg-blue-700 disabled:bg-gray-400 flex items-center justify-center">
                {isLoading ? <Loader2 className="w-5 h-5 mr-2 animate-spin" /> : '儲存變更'}
            </button>
        </main>
    );
};


// --- Main App Component ---
export default function App() {
    // App State
    const [view, setView] = React.useState({ name: 'home', params: {} });
    const [activeTab, setActiveTab] = React.useState('home');
    const [cart, setCart] = React.useState([]);
    const [isCartOpen, setIsCartOpen] = React.useState(false);
    const [toast, setToast] = React.useState(null);
    const [messagingTarget, setMessagingTarget] = React.useState(null);

    // Auth State
    const [firebaseUser, setFirebaseUser] = React.useState(null);
    const [currentUser, setCurrentUser] = React.useState(null);
    const [isProfileIncomplete, setIsProfileIncomplete] = React.useState(false);
    const [isLoading, setIsLoading] = React.useState(true);

    // Firestore Data State
    const [stores, setStores] = React.useState([]);
    const [wishlist, setWishlist] = React.useState([]);
    const [groupBuys, setGroupBuys] = React.useState([]);
    const [teaStores, setTeaStores] = React.useState([]);
    const [teaMenus, setTeaMenus] = React.useState({});
    const [pings, setPings] = React.useState([]);
    const [allUsers, setAllUsers] = React.useState([]);
    const [notifications, setNotifications] = React.useState([]);
    const [transactions, setTransactions] = React.useState([]);
    const [pointsHistory, setPointsHistory] = React.useState([]);
    
    // --- Data Seeding ---
    React.useEffect(() => {
        const seedData = async () => {
            const seedFlagRef = doc(db, "system", "seeded_v3");
            const seedFlagSnap = await getDoc(seedFlagRef);
            if (!seedFlagSnap.exists()) {
                console.log("First time setup: Seeding database...");
                const batch = writeBatch(db);

                MOCK_STORES.forEach(store => {
                    const storeRef = doc(db, "stores", store.id);
                    batch.set(storeRef, store);
                });
                MOCK_GROUP_BUYS.forEach(gb => {
                    const gbRef = doc(db, "groupBuys", gb.id);
                    batch.set(gbRef, gb);
                });
                MOCK_WISHLIST.forEach(wish => {
                    const wishRef = doc(collection(db, "wishlist"));
                    batch.set(wishRef, wish);
                });
                MOCK_TEA_STORES.forEach(ts => {
                    const tsRef = doc(db, "teaStores", ts.id);
                    batch.set(tsRef, ts);
                    if(MOCK_TEA_MENU[ts.id]){
                        MOCK_TEA_MENU[ts.id].forEach(item => {
                            const itemRef = doc(db, `teaStores/${ts.id}/menu`, item.id);
                            batch.set(itemRef, item);
                        });
                    }
                });

                batch.set(seedFlagRef, { done: true, timestamp: serverTimestamp() });
                await batch.commit();
                console.log("Database seeded successfully.");
            }
        };
        seedData();
    }, []);

    // --- Auth Effect ---
    React.useEffect(() => {
        const unsubscribe = onAuthStateChanged(auth, async (user) => {
            setIsLoading(true);
            if (user) {
                setFirebaseUser(user);
                const userDocRef = doc(db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists()) {
                    const userData = userDocSnap.data();
                    if (!userData.role) {
                        await updateDoc(userDocRef, { role: 'admin' });
                        userData.role = 'admin';
                    }

                    if (userData.name) {
                        setCurrentUser({ id: user.uid, ...userData });
                        setIsProfileIncomplete(false);
                    } else {
                        setIsProfileIncomplete(true);
                        setCurrentUser(null);
                    }
                } else {
                    await setDoc(userDocRef, { role: 'admin' }); 
                    setIsProfileIncomplete(true);
                    setCurrentUser(null);
                }
            } else {
                setFirebaseUser(null);
                setCurrentUser(null);
                setIsProfileIncomplete(false);
            }
            setIsLoading(false);
        });
        return () => unsubscribe();
    }, []);

    // --- Firestore Listeners ---
    React.useEffect(() => {
        if (!currentUser?.id) return;
        
        const unsubscribers = [
            onSnapshot(collection(db, "stores"), snap => setStores(snap.docs.map(d => ({ id: d.id, ...d.data() })))),
            onSnapshot(query(collection(db, "wishlist"), orderBy("createdAt", "desc")), snap => setWishlist(snap.docs.map(d => ({ id: d.id, ...d.data() })))),
            onSnapshot(collection(db, "groupBuys"), snap => setGroupBuys(snap.docs.map(d => ({ id: d.id, ...d.data() })))),
            onSnapshot(collection(db, "teaStores"), snap => setTeaStores(snap.docs.map(d => ({ id: d.id, ...d.data() })))),
            onSnapshot(collection(db, "pings"), snap => setPings(snap.docs.map(d => ({ id: d.id, ...d.data() })))),
            onSnapshot(collection(db, "users", currentUser.id, "notifications"), snap => setNotifications(snap.docs.map(d => ({ id: d.id, ...d.data() })))),
            onSnapshot(collection(db, "users", currentUser.id, "transactions"), snap => setTransactions(snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => b.timestamp.toDate() - a.timestamp.toDate()))),
            onSnapshot(collection(db, "users", currentUser.id, "points"), snap => setPointsHistory(snap.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => b.timestamp.toDate() - a.timestamp.toDate()))),
            onSnapshot(doc(db, "users", currentUser.id), doc => { if (doc.exists()) setCurrentUser({ id: doc.id, ...doc.data() }); })
        ];
        
        if (currentUser.role === 'admin' || view.name === 'wishlist' || view.name === 'wishDetail') {
            unsubscribers.push(onSnapshot(collection(db, "users"), snap => setAllUsers(snap.docs.map(d => ({ id: d.id, ...d.data() })))));
        }

        return () => unsubscribers.forEach(unsub => unsub());
    }, [currentUser?.id, currentUser?.role, view.name]);

    React.useEffect(() => {
        if(teaStores.length > 0) {
            const fetchMenus = async () => {
                const menus = {};
                for (const store of teaStores) {
                    const menuCol = collection(db, `teaStores/${store.id}/menu`);
                    const menuSnap = await getDocs(menuCol);
                    menus[store.id] = menuSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                }
                setTeaMenus(menus);
            }
            fetchMenus();
        }
    }, [teaStores]);

    // --- Handlers ---
    const showToast = (message, type = 'info') => setToast({ message, type, id: Date.now() });
    const handleRegistrationComplete = (newProfile) => {
        setCurrentUser(newProfile);
        setIsProfileIncomplete(false);
        showToast('註冊成功！歡迎加入！', 'success');
    };

    const handleProfileUpdate = async (updatedData) => {
        if (!currentUser) return;
        const userDocRef = doc(db, "users", currentUser.id);
        try {
            const avatarChar = (updatedData.nickname || '').trim()[0] || (updatedData.name || '').trim()[0] || ' ';
            const newAvatarUrl = `https://placehold.co/100x100/CCCCCC/FFFFFF?text=${encodeURIComponent(avatarChar)}`;
            const dataToUpdate = { ...updatedData, avatarUrl: newAvatarUrl };
            await updateDoc(userDocRef, dataToUpdate);
            setView({ name: 'profile' });
            showToast('個人資料已更新', 'success');
        } catch (error) {
            console.error("Error updating profile: ", error);
            showToast('更新失敗，請稍後再試', 'error');
        }
    };
    
    const handleIdUpload = async (dataUrl) => {
        if (!currentUser) return;
        const userDocRef = doc(db, "users", currentUser.id);
        try {
            await updateDoc(userDocRef, { idCardUrl: dataUrl });
            showToast('識別證已更新', 'success');
        } catch (error) {
            console.error("Error uploading ID card:", error);
            showToast('上傳失敗，請稍後再試', 'error');
        }
    };

    const handleToggleFavorite = async (storeId) => {
        if (!currentUser) return;
        const userDocRef = doc(db, "users", currentUser.id);
        const currentFavorites = currentUser.favorites || [];
        const newFavorites = currentFavorites.includes(storeId)
            ? currentFavorites.filter(id => id !== storeId)
            : [...currentFavorites, storeId];
        await updateDoc(userDocRef, { favorites: newFavorites });
    };

    const handleWish = async (wishId) => {
        if (!currentUser) return;
        const wishRef = doc(db, "wishlist", wishId);
        const wishDoc = await getDoc(wishRef);
        if (wishDoc.exists()) {
            const data = wishDoc.data();
            const hasWished = data.wishedBy.includes(currentUser.id);
            
            if (hasWished) {
                await updateDoc(wishRef, {
                    wishes: increment(-1),
                    wishedBy: arrayRemove(currentUser.id)
                });
            } else {
                await updateDoc(wishRef, {
                    wishes: increment(1),
                    wishedBy: arrayUnion(currentUser.id)
                });
            }
        }
    };
    
    const handleAddWish = async (wishData) => {
        await addDoc(collection(db, "wishlist"), wishData);
        showToast('許願成功！', 'success');
    };
    
    const handleAddComment = async (wishId, commentText) => {
        if(!commentText.trim()) return;
        const wishRef = doc(db, "wishlist", wishId);
        const commentCol = collection(db, `wishlist/${wishId}/comments`);
        
        const batch = writeBatch(db);
        batch.update(wishRef, { commentCount: increment(1) });
        batch.set(doc(commentCol), {
            text: commentText.trim(),
            creatorId: currentUser.id,
            creatorName: currentUser.name,
            creatorAvatarUrl: currentUser.avatarUrl,
            createdAt: serverTimestamp()
        });
        await batch.commit();
    };
    
    const handleSendMessage = async (recipientId, wishId, text) => {
        if (!text.trim()) return;
        await addDoc(collection(db, 'messages'), {
            text: text.trim(),
            senderId: currentUser.id,
            receiverId: recipientId,
            wishId: wishId,
            createdAt: serverTimestamp(),
            isRead: false,
        });
        showToast('訊息已傳送！', 'success');
        setMessagingTarget(null);
    };

    const handleCheckIn = async () => {
        const today = new Date().toISOString().slice(0, 10);
        if (currentUser?.lastCheckIn !== today) {
            const userDocRef = doc(db, "users", currentUser.id);
            const pointsRef = collection(db, "users", currentUser.id, "points");
            await updateDoc(userDocRef, {
                points: currentUser.points + 10,
                lastCheckIn: today
            });
            await addDoc(pointsRef, {
                type: 'checkin',
                description: '每日簽到',
                points: 10,
                timestamp: new Date()
            });
            showToast('簽到成功！獲得 10 點', 'success');
        }
    };
    
    const handleAddToCart = (itemToAdd) => {
        setCart(prevCart => [...prevCart, { ...itemToAdd, cartId: Date.now() }]);
        showToast(`${itemToAdd.name} 已加入購物車`);
    };

    const handleCheckout = async (total) => {
        if (currentUser.walletBalance < total) {
            showToast('餘額不足！', 'error');
            return;
        }
        const userDocRef = doc(db, "users", currentUser.id);
        const txsRef = collection(db, "users", currentUser.id, "transactions");

        await updateDoc(userDocRef, {
            walletBalance: currentUser.walletBalance - total
        });
        await addDoc(txsRef, {
            type: 'purchase',
            description: cart.map(item => `${item.name} x${item.quantity}`).join(', '),
            amount: -total,
            timestamp: new Date()
        });

        setCart([]);
        setIsCartOpen(false);
        showToast('訂購成功！', 'success');
        setView({ name: 'home' });
        setActiveTab('home');
    };

    const handleStartPing = async (item) => {
        if(currentUser.walletBalance < item.groupPrice) {
            showToast('錢包餘額不足', 'error');
            return;
        }
        const batch = writeBatch(db);
        const userRef = doc(db, "users", currentUser.id);
        const pingRef = doc(collection(db, 'pings'));
        const txRef = doc(collection(db, `users/${currentUser.id}/transactions`));
        
        batch.update(userRef, { walletBalance: increment(-item.groupPrice) });
        batch.set(pingRef, {
            itemId: item.id,
            leader: currentUser.id,
            members: [currentUser.id],
            endDate: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(),
            createdAt: serverTimestamp(),
            status: 'active'
        });
        batch.set(txRef, {
            type: 'groupbuy_hold',
            description: `[預扣] ${item.name}`,
            amount: -item.groupPrice,
            timestamp: serverTimestamp(),
            pingId: pingRef.id
        });
        
        await batch.commit();
        showToast('已成功發起拼團！', 'success');
    };

    const handleJoinPing = async (pingId, item) => {
         if(currentUser.walletBalance < item.groupPrice) {
            showToast('錢包餘額不足', 'error');
            return;
        }
        const batch = writeBatch(db);
        const userRef = doc(db, "users", currentUser.id);
        const pingRef = doc(db, 'pings', pingId);
        const txRef = doc(collection(db, `users/${currentUser.id}/transactions`));
        
        batch.update(userRef, { walletBalance: increment(-item.groupPrice) });
        batch.update(pingRef, { members: arrayUnion(currentUser.id) });
        batch.set(txRef, {
            type: 'groupbuy_hold',
            description: `[預扣] ${item.name}`,
            amount: -item.groupPrice,
            timestamp: serverTimestamp(),
            pingId: pingRef.id
        });

        await batch.commit();
        showToast('已成功加入拼團！', 'success');
    }

    const handleActivateUser = async (userId) => {
        const userRef = doc(db, "users", userId);
        await updateDoc(userRef, { status: "active" });
        showToast("使用者已成功激活", "success");
    };


    // --- Navigation & Rendering ---
    const handleBack = () => {
        const currentViewName = view.name;
        if (['editProfile', 'transactions', 'points', 'idCard', 'admin'].includes(currentViewName)) {
            setView({ name: 'profile' });
        } else if (currentViewName === 'groupBuyDetail') {
            setView({ name: 'groupbuy' });
        } else if (currentViewName === 'teaOrder') {
            setView({ name: 'tea' });
        } else if (currentViewName === 'wishDetail') {
            setView({ name: 'wishlist' });
        } else if (currentViewName === 'profile') {
            setView({ name: 'home' });
            setActiveTab('home');
        } else {
            setView({ name: 'home' });
            setActiveTab('home');
        }
    };
    
    React.useEffect(() => {
        if (['home', 'groupbuy', 'tea', 'wishlist'].includes(activeTab)) {
            setView({ name: activeTab });
        } else if (activeTab === 'profile') {
            setView({ name: 'profile' });
        }
    }, [activeTab]);

    const renderContent = () => {
        if (!currentUser) return null;

        switch (view.name) {
            case 'home': return <HomeScreen stores={stores} currentUser={currentUser} onToggleFavorite={handleToggleFavorite} onSelectStore={(store) => { /* Navigate to store detail */ }} />;
            case 'groupbuy': return <GroupBuyScreen groupBuys={groupBuys} onSelect={(item) => setView({name: 'groupBuyDetail', params: {item}})} />;
            case 'tea': return <AfternoonTeaScreen teaStores={teaStores} onSelectStore={(store) => setView({ name: 'teaOrder', params: { store } })} />;
            case 'wishlist': return <WishlistScreen wishlist={wishlist} currentUser={currentUser} allUsers={allUsers} onWish={handleWish} onAddWish={handleAddWish} setView={setView} onSendMessage={(recipient, wishId) => setMessagingTarget({recipient, wishId})} />;
            case 'profile': return <ProfileScreen currentUser={currentUser} onCheckIn={handleCheckIn} canCheckIn={currentUser?.lastCheckIn !== new Date().toISOString().slice(0, 10)} setView={setView} />;
            case 'editProfile': return <EditProfileScreen currentUser={currentUser} onSave={handleProfileUpdate} />;
            case 'transactions': return <TransactionHistoryScreen transactions={transactions} />;
            case 'points': return <PointHistoryScreen pointsHistory={pointsHistory} />;
            case 'idCard': return <IdCardModal currentUser={currentUser} onUpload={handleIdUpload} onClose={() => setView({name: 'profile'})} />;
            case 'teaOrder': return <TeaOrderScreen store={view.params.store} menu={teaMenus[view.params.store.id] || []} onAddToCart={handleAddToCart} />;
            case 'groupBuyDetail': return <GroupBuyDetailModal item={view.params.item} user={currentUser} onClose={() => setView({name: 'groupbuy'})} onStartPing={handleStartPing} onJoinPing={handleJoinPing} activePings={pings.filter(p => p.itemId === view.params.item.id)} />;
            case 'admin': return <AdminScreen allUsers={allUsers} onActivateUser={handleActivateUser} />;
            case 'wishDetail': return <WishDetailScreen wishId={view.params.wishId} wishlist={wishlist} currentUser={currentUser} allUsers={allUsers} onWish={handleWish} onAddComment={handleAddComment} />;
            default: return <HomeScreen stores={stores} currentUser={currentUser} onToggleFavorite={handleToggleFavorite} onSelectStore={() => {}} />;
        }
    };
    
    const getTitle = () => {
        const titles = {
            home: '特約商店', groupbuy: '社交拼團', tea: '訂下午茶', wishlist: '許願池', profile: '我的帳號',
            editProfile: '編輯個人資料', transactions: '交易紀錄', points: '點數紀錄',
            teaOrder: view.params?.store?.name || '訂購',
            groupBuyDetail: '商品詳情',
            idCard: '我的員工證',
            admin: '管理員後台',
            wishDetail: '願望詳情'
        };
        return titles[view.name] || '企業福利平台';
    };

    // --- Loading & Auth Screens ---
    if (isLoading) {
        return (<div className="bg-gray-100 min-h-screen font-sans flex justify-center items-center p-4"><div className="w-full max-w-md mx-auto bg-white shadow-lg rounded-3xl border-8 border-black relative h-[800px] flex flex-col overflow-hidden"><div className="flex flex-col items-center justify-center h-full"><Loader2 className="w-12 h-12 text-blue-500 animate-spin" /><p className="mt-4 text-gray-500">正在載入...</p></div></div></div>);
    }
    if (!firebaseUser) {
        return (<div className="bg-gray-100 min-h-screen font-sans flex justify-center items-center p-4"><div className="w-full max-w-md mx-auto bg-white shadow-lg rounded-3xl border-8 border-black relative h-[800px] flex flex-col overflow-hidden"><AuthScreen /></div></div>);
    }
    if (isProfileIncomplete) {
        return (<div className="bg-gray-100 min-h-screen font-sans flex justify-center items-center p-4"><div className="w-full max-w-md mx-auto bg-white shadow-lg rounded-3xl border-8 border-black relative h-[800px] flex flex-col overflow-hidden"><RegistrationScreen firebaseUser={firebaseUser} onRegistrationComplete={handleRegistrationComplete} /></div></div>);
    }

    const showBackButton = !['home', 'groupbuy', 'tea', 'wishlist'].includes(view.name);
    const showNavBar = ['home', 'groupbuy', 'tea', 'wishlist'].includes(view.name);

    return (
        <div className="bg-gray-100 min-h-screen font-sans flex justify-center items-center p-4">
            <div className="w-full max-w-md mx-auto bg-white shadow-lg rounded-3xl border-8 border-black relative h-[800px] flex flex-col overflow-hidden">
                {toast && <Toast key={toast.id} message={toast.message} type={toast.type} onDismiss={() => setToast(null)} />}
                <AppHeader
                    title={getTitle()}
                    onBack={handleBack}
                    showBackButton={showBackButton}
                    notifications={notifications}
                    onMarkAllRead={() => { /* Implement mark all read */ }}
                    onProfileClick={() => { setView({ name: 'profile' }); setActiveTab('profile'); }}
                />
                <div className="flex-grow overflow-y-auto">
                    <div className="pb-16">
                        {renderContent()}
                    </div>
                </div>
                {showNavBar && <BottomNavBar activeTab={activeTab} setActiveTab={setActiveTab} />}
                {cart.length > 0 && !isCartOpen && (<div className="absolute bottom-20 right-4 z-30"><button onClick={() => setIsCartOpen(true)} className="bg-blue-600 text-white rounded-full shadow-lg p-4 flex items-center space-x-2 animate-bounce"><ShoppingCart /><span className="font-bold">{cart.reduce((acc, item) => acc + item.quantity, 0)}</span></button></div>)}
                {isCartOpen && <CartModal cart={cart} setCart={setCart} user={currentUser} onCheckout={handleCheckout} onClose={() => setIsCartOpen(false)} />}
                {messagingTarget && <MessageModal recipient={messagingTarget.recipient} wishId={messagingTarget.wishId} onClose={() => setMessagingTarget(null)} onSendMessage={handleSendMessage} />}
            </div>
        </div>
    );
}

// --- Modals ---
const IdCardModal = ({ currentUser, onUpload, onClose }) => {
    const fileInputRef = React.useRef(null);
    const [isUploading, setIsUploading] = React.useState(false);

    const handleFileChange = (event) => {
        const file = event.target.files[0];
        if (file) {
            setIsUploading(true);
            const reader = new FileReader();
            reader.onload = (e) => {
                onUpload(e.target.result);
                setIsUploading(false);
            };
            reader.onerror = () => {
                setIsUploading(false);
                alert("讀取檔案失敗");
            }
            reader.readAsDataURL(file);
        }
    };

    const triggerFileUpload = () => {
        fileInputRef.current.click();
    };

    return (
        <div className="absolute inset-0 bg-gray-800 z-40 animate-fade-in p-4 flex flex-col justify-center items-center">
             <button onClick={onClose} className="absolute top-4 right-4 text-white bg-black/30 rounded-full p-2"><X size={24}/></button>
            <div className="w-full max-w-sm bg-white rounded-2xl p-6 text-center shadow-2xl">
                <h2 className="text-xl font-bold text-gray-800">{currentUser.name}</h2>
                <p className="text-gray-500">{MOCK_COMPANIES[currentUser.companyId]?.name}</p>
                <div className="mt-4 w-full aspect-[1.586/1] bg-gray-100 rounded-lg flex justify-center items-center overflow-hidden border-2 border-dashed">
                    {currentUser.idCardUrl ? (
                         <img src={currentUser.idCardUrl} alt="員工識別證" className="w-full h-full object-contain" />
                    ) : (
                        <div className="text-gray-400 flex flex-col items-center">
                            <Badge size={48} />
                            <p className="mt-2 font-semibold">尚未上傳識別證</p>
                        </div>
                    )}
                </div>
                <input
                    type="file"
                    ref={fileInputRef}
                    onChange={handleFileChange}
                    className="hidden"
                    accept="image/*"
                />
                <button 
                    onClick={triggerFileUpload} 
                    disabled={isUploading}
                    className="mt-6 w-full bg-blue-600 text-white font-bold py-3 rounded-lg active:bg-blue-700 disabled:bg-gray-400 flex items-center justify-center gap-2"
                >
                    {isUploading ? <Loader2 className="animate-spin" /> : <UploadCloud />}
                    {currentUser.idCardUrl ? '更換照片' : '上傳照片'}
                </button>
            </div>
        </div>
    );
};

const GroupBuyDetailModal = ({ item, user, onClose, onStartPing, onJoinPing, activePings }) => {
    if (!item) return null;

    const userPing = activePings.find(p => p.members.includes(user.id));
    if (userPing) {
        return <PingStatusModal ping={userPing} item={item} user={user} onClose={onClose} />;
    }
    
    const availablePings = activePings.filter(p => p.members.length < item.groupSize);

    return (
        <div className="absolute inset-0 bg-white z-40 animate-fade-in">
            <div className="h-full w-full flex flex-col">
                <div className="bg-white sticky top-0 z-10 border-b border-gray-200"><div className="px-4 h-14 flex items-center justify-between"><button onClick={onClose} className="text-blue-600 font-semibold">返回</button><h2 className="font-bold text-gray-800">商品詳情</h2><div className="w-12"></div></div></div>
                <div className="flex-grow overflow-y-auto">
                    <img src={item.imageUrl} alt={item.name} className="w-full h-64 object-cover" />
                    <div className="p-4">
                        <h2 className="text-3xl font-bold">{item.name}</h2>
                        <p className="text-gray-700 mt-4">{item.description}</p>
                    </div>
                    {availablePings.length > 0 && (
                        <div className="p-4">
                            <h3 className="font-bold mb-2">進行中的團 (可直接加入)</h3>
                            <div className="space-y-2">{availablePings.map(ping => <PingJoinCard key={ping.id} ping={ping} item={item} onJoinPing={onJoinPing} />)}</div>
                        </div>
                    )}
                </div>
                <div className="p-4 bg-white border-t grid grid-cols-2 gap-2">
                    <button className="bg-gray-200 text-gray-800 font-bold py-3 rounded-lg flex flex-col items-center"><span>NT$ {item.marketPrice}</span><span className="text-xs">單獨購買</span></button>
                    <button onClick={() => onStartPing(item)} className="bg-red-500 text-white font-bold py-3 rounded-lg flex flex-col items-center"><span>NT$ {item.groupPrice}</span><span className="text-xs">{item.groupSize}人拼團</span></button>
                </div>
            </div>
        </div>
    );
};

const PingJoinCard = ({ ping, item, onJoinPing }) => {
    const { timeLeft, isEnded } = useCountdown(ping.endDate);
    if (isEnded) return null;

    const daysText = timeLeft.days > 0 ? `${timeLeft.days}天 ` : '';
    const hoursText = `${String(timeLeft.hours).padStart(2, '0')}`;
    const minutesText = `${String(timeLeft.minutes).padStart(2, '0')}`;
    const countdownText = `剩餘 ${daysText}${hoursText}:${minutesText}`;

    return (
        <div className="bg-gray-100 rounded-lg p-3 flex items-center justify-between">
            <div className="flex items-center">
                 <User className="w-10 h-10 rounded-full bg-gray-300 p-2" />
                <div className="ml-3">
                    <p className="font-semibold">一位同事的團</p>
                    <p className="text-xs text-gray-500">還差 {item.groupSize - ping.members.length} 人，{countdownText}</p>
                </div>
            </div>
            <button onClick={() => onJoinPing(ping.id, item)} className="bg-red-500 text-white font-bold px-4 py-2 rounded-lg text-sm">加入</button>
        </div>
    );
};

const PingStatusModal = ({ ping, item, user, onClose }) => {
    const { timeLeft, isEnded } = useCountdown(ping.endDate);
    const isSuccess = ping.members.length >= item.groupSize;
    const handleShare = () => {
        alert(`已複製拼團連結！\n快來加入「${item.name}」團！還差 ${item.groupSize - ping.members.length} 人！`);
    }

    const countdownText = `${timeLeft.days > 0 ? `${timeLeft.days}天 ` : ''}${String(timeLeft.hours).padStart(2, '0')}:${String(timeLeft.minutes).padStart(2, '0')}:${String(timeLeft.seconds).padStart(2, '0')}`;

    return (
        <div className="absolute inset-0 bg-white z-40 animate-fade-in">
            <div className="h-full w-full flex flex-col items-center p-4">
                <div className="w-full flex justify-end"><button onClick={onClose} className="text-blue-600 font-semibold">完成</button></div>
                <div className="text-center mt-8">
                    <h2 className="text-2xl font-bold">{isSuccess ? "拼團成功！" : isEnded ? "拼團失敗" : "拼團中..."}</h2>
                    <p className="text-gray-600 mt-2">{isSuccess ? "已為您成立訂單" : isEnded ? "已將款項退回您的錢包" : `還差 ${item.groupSize - ping.members.length} 人，快邀請同事加入！`}</p>
                    <div className="mt-4 font-semibold text-2xl text-red-500">{isEnded || isSuccess ? "" : countdownText}</div>
                </div>
                <div className="my-8 flex items-center space-x-2">
                    {ping.members.map(memberId => <User key={memberId} className="w-12 h-12 rounded-full border-2 border-white bg-blue-200 p-2" />)}
                    {[...Array(item.groupSize - ping.members.length)].map((_, i) => <div key={i} className="w-12 h-12 rounded-full bg-gray-200 border-2 border-dashed flex items-center justify-center"><User className="text-gray-400" /></div>)}
                </div>
                <div className="w-full max-w-sm">
                    <button onClick={handleShare} disabled={isSuccess || isEnded} className="w-full bg-red-500 text-white font-bold py-4 rounded-lg text-lg disabled:bg-gray-400 flex items-center justify-center gap-2"><Share2 />邀請同事加入</button>
                </div>
            </div>
        </div>
    );
};

// --- Admin Components ---
const AdminScreen = ({ allUsers, onActivateUser }) => {
    const pendingUsers = allUsers.filter(u => u.status === 'pending_verification');
    const activeUsers = allUsers.filter(u => u.status === 'active');

    return (
        <main className="p-4 space-y-6">
            <div>
                <h2 className="text-lg font-bold text-gray-800 mb-2">待審核使用者 ({pendingUsers.length})</h2>
                {pendingUsers.length > 0 ? (
                    <div className="bg-white rounded-xl border border-gray-200 divide-y divide-gray-200">
                        {pendingUsers.map(user => (
                            <div key={user.id} className="p-3 flex justify-between items-center">
                                <div>
                                    <p className="font-semibold">{user.name}</p>
                                    <p className="text-sm text-gray-500">{MOCK_COMPANIES[user.companyId]?.name}</p>
                                </div>
                                <button onClick={() => onActivateUser(user.id)} className="bg-green-500 text-white font-semibold px-3 py-1 rounded-lg text-sm">激活</button>
                            </div>
                        ))}
                    </div>
                ) : <p className="text-sm text-gray-500">沒有待審核的使用者。</p>}
            </div>
            <div>
                <h2 className="text-lg font-bold text-gray-800 mb-2">已激活使用者 ({activeUsers.length})</h2>
                 {activeUsers.length > 0 ? (
                    <div className="bg-white rounded-xl border border-gray-200 divide-y divide-gray-200">
                        {activeUsers.map(user => (
                            <div key={user.id} className="p-3 flex justify-between items-center">
                                <div>
                                    <p className="font-semibold">{user.name}</p>
                                    <p className="text-sm text-gray-500">{MOCK_COMPANIES[user.companyId]?.name}</p>
                                </div>
                                <span className="text-green-600 font-semibold text-sm">已激活</span>
                            </div>
                        ))}
                    </div>
                ) : <p className="text-sm text-gray-500">沒有已激活的使用者。</p>}
            </div>
        </main>
    )
}

const WishDetailScreen = ({ wishId, wishlist, currentUser, allUsers, onWish, onAddComment }) => {
    const [comments, setComments] = React.useState([]);
    const [commentText, setCommentText] = React.useState('');
    const wish = wishlist.find(w => w.id === wishId);

    React.useEffect(() => {
        if (!wishId) return;
        const q = query(collection(db, `wishlist/${wishId}/comments`), orderBy('createdAt', 'asc'));
        const unsubscribe = onSnapshot(q, (snapshot) => {
            setComments(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
        });
        return () => unsubscribe();
    }, [wishId]);

    const getUserInfo = (userId) => {
        return allUsers.find(u => u.id === userId) || { name: '匿名', avatarUrl: 'https://placehold.co/100x100/CCCCCC/FFFFFF?text=?' };
    };

    const handleCommentSubmit = (e) => {
        e.preventDefault();
        onAddComment(wishId, commentText);
        setCommentText('');
    };

    if (!wish) {
        return <div className="p-4 text-center">讀取中...</div>;
    }

    return (
        <main className="flex flex-col h-full">
            <div className="p-4">
                <WishCard wish={wish} currentUser={currentUser} onWish={onWish} creator={getUserInfo(wish.creatorId)} onSelect={() => {}} />
            </div>
            <h3 className="px-4 pb-2 font-bold text-lg border-b">留言區</h3>
            <div className="flex-grow overflow-y-auto p-4 space-y-4">
                {comments.map(comment => (
                    <div key={comment.id} className="flex items-start space-x-3">
                        <img src={comment.creatorAvatarUrl} alt={comment.creatorName} className="w-10 h-10 rounded-full" />
                        <div className="bg-gray-100 p-3 rounded-lg flex-1">
                            <p className="font-semibold text-sm">{comment.creatorName}</p>
                            <p className="text-gray-800">{comment.text}</p>
                        </div>
                    </div>
                ))}
            </div>
            <form onSubmit={handleCommentSubmit} className="p-2 border-t bg-white flex items-center gap-2">
                <input 
                    type="text"
                    value={commentText}
                    onChange={e => setCommentText(e.target.value)}
                    placeholder="發表您的看法..."
                    className="w-full h-10 px-4 bg-gray-100 border-transparent rounded-full focus:ring-2 focus:ring-blue-500"
                />
                <button type="submit" className="bg-blue-600 text-white font-bold p-2 rounded-full">
                    <MessageCircle />
                </button>
            </form>
        </main>
    );
};

const MessageModal = ({ recipient, wishId, onClose, onSendMessage }) => {
    const [text, setText] = React.useState('');

    const handleSubmit = () => {
        onSendMessage(recipient.id, wishId, text);
    };

    return (
        <div className="absolute inset-0 bg-black/60 z-50 flex justify-center items-center p-4" onClick={onClose}>
            <div className="bg-white rounded-2xl w-full max-w-sm animate-fade-in-up" onClick={e => e.stopPropagation()}>
                <h3 className="text-lg font-bold text-center p-4 border-b">傳送私訊給 {recipient.name}</h3>
                <div className="p-4">
                    <textarea value={text} onChange={e => setText(e.target.value)} placeholder="輸入您的訊息..." rows="5" className="w-full p-2 bg-gray-100 rounded-lg border-transparent focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                <div className="p-4 border-t flex justify-end gap-2">
                    <button onClick={onClose} className="px-4 py-2 rounded-lg font-semibold bg-gray-200">取消</button>
                    <button onClick={handleSubmit} className="px-4 py-2 rounded-lg font-semibold bg-blue-600 text-white">傳送</button>
                </div>
            </div>
        </div>
    );
};
