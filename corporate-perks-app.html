import React, { useState, useMemo, useEffect } from 'react';
import { Search, MapPin, Building, X, ThumbsUp, Star, QrCode, ArrowLeft, Users, Heart, PlusCircle, Home, Gift, User, Bell, Tag, Share2, CheckCircle, Award, ShoppingBag, ChevronRight, Clock, Wallet, Coffee, Minus, Plus, ShoppingCart, TrendingUp, TrendingDown, Phone, Loader2, LogOut } from 'lucide-react';
import { initializeApp } from 'firebase/app';
import { getFirestore, collection, getDocs, doc, getDoc, setDoc } from 'firebase/firestore';
import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "firebase/auth";


// --- Firebase 設定 ---
const firebaseConfig = {
  apiKey: "AIzaSyCH19CEf7ybXeJE-ZErIScVc8fXFrwh5Zw",
  authDomain: "corporate-perks-app.firebaseapp.com",
  projectId: "corporate-perks-app",
  storageBucket: "corporate-perks-app.appspot.com",
  messagingSenderId: "104236011894",
  appId: "1:104236011894:web:f858f533ac72594458ea57"
};

// 初始化 Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);


// --- 模擬資料 (平台模型) ---
const companies = {
  'company-a': { 
    id: 'company-a', 
    name: '卓越科技有限公司',
    address: '台北市信義區信義路五段7號 89樓',
    phone: '02-8101-8888',
    welfareId: 'WEL-TW-101'
  },
  'company-b': { 
    id: 'company-b', 
    name: '創新國際股份有限公司',
    address: '新竹市東區科學園區工業東二路1號',
    phone: '03-578-1234',
    welfareId: 'WEL-HS-007'
  },
};

const categories = ['美食餐飲', '休閒娛樂', '生活百貨', '美容美髮', '交通出行', '學習成長'];

const teaStores = [
    { id: 'ts-1', name: '50嵐', logo: 'https://placehold.co/100x100/F9A825/000000?text=50嵐', description: '台灣知名連鎖手搖飲品牌。' },
    { id: 'ts-2', name: '可不可熟成紅茶', logo: 'https://placehold.co/100x100/000000/FFFFFF?text=KEBUKE', description: '專注於熟成紅茶的特色飲品店。' },
];

const sampleMenu = {
    'ts-1': [
        { id: '50-1', name: '珍珠奶茶', price: 50, options: { sugar: ['正常糖', '少糖', '半糖', '微糖', '無糖'], ice: ['正常冰', '少冰', '微冰', '去冰', '溫', '熱'] }, imageUrl: 'https://placehold.co/400x400/FFC107/000000?text=珍珠奶茶' },
        { id: '50-2', name: '四季春青茶', price: 35, options: { sugar: ['正常糖', '少糖', '半糖', '微糖', '無糖'], ice: ['正常冰', '少冰', '微冰', '去冰'] }, imageUrl: 'https://placehold.co/400x400/8BC34A/FFFFFF?text=四季春' },
    ],
    'ts-2': [
        { id: 'kbk-1', name: '熟成紅茶', price: 35, options: { sugar: ['正常', '八分', '五分', '三分', '無糖'], ice: ['正常', '少冰', '微冰', '去冰', '溫', '熱'] }, imageUrl: 'https://placehold.co/400x400/795548/FFFFFF?text=熟成紅茶' },
        { id: 'kbk-2', name: '白玉歐蕾', price: 60, options: { sugar: ['正常', '八分', '五分', '三分', '無糖'], ice: ['正常', '少冰', '微冰', '去冰'] }, imageUrl: 'https://placehold.co/400x400/D7CCC8/3E2723?text=白玉歐蕾' },
    ],
};

const initialWishlist = [ { id: 1, name: '海底撈火鍋', category: '美食餐飲', wishes: 128, wishedBy: [] }];
const initialNotifications = [ { id: 1, type: 'new_store', title: '新店家加入！', content: 'Cama Café 已加入特約行列！', timestamp: '2 小時前', read: false }];
const initialGroupBuys = [
    { id: 'gb-1', name: '辦公室零食箱 (豪華版)', description: '精選來自世界各地的20種人氣零食，從經典洋芋片到健康堅果棒，一次滿足您辦公室的味蕾。適合部門分享，提振下午精神！', marketPrice: 1200, groupPrice: 899, groupSize: 3, imageUrl: 'https://placehold.co/600x400/FFC107/FFFFFF?text=零食箱', joinedBy: [], endDate: new Date(Date.now() + 2 * 24 * 60 * 60 * 1000).toISOString() },
    { id: 'gb-2', name: '人氣店家手作蛋捲禮盒', description: '每日新鮮現做，採用頂級原料，口感酥脆香濃。無論是送禮還是自用，都是最有誠意的選擇。限量供應，售完為止。', marketPrice: 500, groupPrice: 380, groupSize: 2, imageUrl: 'https://placehold.co/600x400/4CAF50/FFFFFF?text=蛋捲禮盒', joinedBy: ['user-1'], endDate: new Date(Date.now() + 1 * 24 * 60 * 60 * 1000 + 5 * 60 * 60 * 1000).toISOString() },
    { id: 'gb-3', name: '精品濾掛咖啡組', description: '嚴選阿拉比卡咖啡豆，中度烘焙帶有果香風味，讓您在辦公室也能享受一杯好咖啡。', marketPrice: 800, groupPrice: 550, groupSize: 5, imageUrl: 'https://placehold.co/600x400/795548/FFFFFF?text=咖啡組', joinedBy: [], endDate: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString() }, // 模擬已結束
];

const suggestionDatabase = [
  '路易莎咖啡 (LOUISA COFFEE)', '大苑子', '康是美', 'NET 主富服飾', '鼎泰豐', '鼎王麻辣鍋', 'IKEA 宜家家居', '家樂福 Carrefour', '全聯福利中心'
];

// --- 模擬交易紀錄資料 ---
const transactionHistoryData = {
  'user-1': [
    { id: 't1', type: 'purchase', description: '50嵐 - 珍珠奶茶', amount: -50, timestamp: '2025-08-22T10:30:00Z' },
    { id: 't2', type: 'groupbuy_refund', description: '手作蛋捲禮盒 (拼團失敗退款)', amount: 380, timestamp: '2025-08-21T15:00:00Z' },
    { id: 't3', type: 'topup', description: '福利金儲值', amount: 500, timestamp: '2025-08-21T09:00:00Z' },
    { id: 't4', type: 'purchase', description: '威秀影城 - 電影票', amount: -240, timestamp: '2025-08-20T18:45:00Z' },
  ],
};

// --- 模擬點數紀錄資料 ---
const pointHistoryData = {
  'user-1': [
    { id: 'p1', type: 'checkin', description: '每日簽到', points: 10, timestamp: '2025-08-22T08:00:00Z' },
    { id: 'p2', type: 'checkin', description: '每日簽到', points: 10, timestamp: '2025-08-21T08:05:00Z' },
    { id: 'p3', type: 'special_event', description: '新用戶註冊獎勵', points: 100, timestamp: '2025-08-20T10:00:00Z' },
  ],
};


// --- 用於倒數計時的 Custom Hook ---
const useCountdown = (endDate) => {
    const [timeLeft, setTimeLeft] = useState({ days: 0, hours: 0, minutes: 0, seconds: 0 });
    const [isEnded, setIsEnded] = useState(false);
    useEffect(() => {
        if (!endDate) return;
        const calculateTimeLeft = () => {
            const difference = +new Date(endDate) - +new Date();
            if (difference > 0) return { days: Math.floor(difference / (1000 * 60 * 60 * 24)), hours: Math.floor((difference / (1000 * 60 * 60)) % 24), minutes: Math.floor((difference / 1000 / 60) % 60), seconds: Math.floor((difference / 1000) % 60) };
            return null;
        };
        const timer = setInterval(() => { const newTimeLeft = calculateTimeLeft(); if (newTimeLeft) { setTimeLeft(newTimeLeft); setIsEnded(false); } else { setIsEnded(true); clearInterval(timer); } }, 1000);
        
        // Initial calculation
        const newTimeLeft = calculateTimeLeft();
        if (newTimeLeft) {
            setTimeLeft(newTimeLeft);
            setIsEnded(false);
        } else {
            setIsEnded(true);
        }

        return () => clearInterval(timer);
    }, [endDate]);
    return { timeLeft, isEnded };
};

// --- 仿原生風格的元件 ---
const AppHeader = ({ title, onBack, showBackButton = false, notifications, onMarkAllRead, onProfileClick }) => {
    const [panelOpen, setPanelOpen] = useState(false);
    const unreadCount = notifications.filter(n => !n.read).length;
    return (
        <header className="bg-white sticky top-0 z-20 border-b border-gray-200">
            <div className="px-4 h-14 flex items-center justify-between">
                <div className="w-1/4">
                    {showBackButton && (<button onClick={onBack} className="flex items-center text-blue-600"><ArrowLeft size={20} /><span className="ml-1 font-semibold">返回</span></button>)}
                </div>
                <h1 className="text-lg font-bold text-gray-900 w-1/2 text-center truncate">{title}</h1>
                <div className="w-1/4 flex justify-end items-center space-x-1">
                    <div className="relative">
                        <button onClick={() => setPanelOpen(!panelOpen)} className="relative p-2 rounded-full active:bg-gray-200 transition-colors">
                            <Bell className="w-6 h-6 text-gray-600" />
                            {unreadCount > 0 && <span className="absolute top-1 right-1 block h-2.5 w-2.5 rounded-full bg-red-500 border-2 border-white"></span>}
                        </button>
                        {panelOpen && <NotificationPanel notifications={notifications} onMarkAllRead={() => { onMarkAllRead(); setPanelOpen(false); }} />}
                    </div>
                   <button onClick={onProfileClick} className="p-2 rounded-full active:bg-gray-200 transition-colors">
                        <User className="w-6 h-6 text-gray-600" />
                    </button>
                </div>
            </div>
        </header>
    );
};

const NotificationPanel = ({ notifications, onMarkAllRead }) => {
    const getIconForType = type => ({ new_store: <Building className="w-5 h-5 text-green-500" />, offer: <Tag className="w-5 h-5 text-red-500" />, wishlist: <Gift className="w-5 h-5 text-yellow-500" /> }[type] || <Bell className="w-5 h-5 text-gray-500" />);
    return (<div className="absolute top-full right-0 mt-2 w-80 bg-white rounded-lg shadow-xl border border-gray-200 z-30 animate-fade-in-down"><div className="p-3 flex justify-between items-center border-b"><h3 className="font-bold">通知中心</h3><button onClick={onMarkAllRead} className="text-xs text-blue-600 font-semibold">全部已讀</button></div><div className="max-h-96 overflow-y-auto">{notifications.length > 0 ? notifications.map(notif => (<div key={notif.id} className={`p-3 flex items-start space-x-3 border-b ${!notif.read ? 'bg-blue-50' : 'bg-white'}`}><div className="flex-shrink-0 mt-1">{getIconForType(notif.type)}</div><div><p className="font-semibold text-sm">{notif.title}</p><p className="text-xs text-gray-600">{notif.content}</p><p className="text-xs text-gray-400 mt-1">{notif.timestamp}</p></div></div>)) : <p className="p-4 text-sm text-gray-500 text-center">沒有新的通知</p>}</div></div>);
};

const BottomNavBar = ({ activeTab, setActiveTab }) => {
    const navItems = [{ id: 'home', icon: Home, label: '主頁' }, { id: 'groupbuy', icon: ShoppingBag, label: '拼團' }, { id: 'tea', icon: Coffee, label: '下午茶' }, { id: 'wishlist', icon: Gift, label: '許願池' }];
    return (<footer className="bg-white/95 backdrop-blur-sm absolute bottom-0 left-0 right-0 z-20 border-t border-gray-200/80"><div className="flex justify-around items-center h-16">{navItems.map(item => (<button key={item.id} onClick={() => setActiveTab(item.id)} className={`flex flex-col items-center justify-center space-y-1 w-full transition-colors ${activeTab === item.id ? 'text-blue-600' : 'text-gray-500 hover:text-blue-600'}`}><item.icon className="w-6 h-6" /><span className="text-xs font-medium">{item.label}</span></button>))}</div></footer>);
};

const StoreCard = ({ store, onSelect, isFavorite, onToggleFavorite, small = false }) => (
  <div className={`bg-white rounded-xl overflow-hidden transform active:scale-95 transition-transform duration-150 ${small ? 'w-48 border border-gray-100' : 'shadow-sm'}`} onClick={() => onSelect(store)}>
    <div className={`flex ${small ? 'flex-col' : 'p-3'}`}>
      <img src={store.logo} alt={`${store.name} logo`} className={`${small ? 'w-full h-24' : 'w-20 h-20 rounded-lg'} flex-shrink-0 object-cover`} />
      <div className={`${small ? 'p-2' : 'ml-4'} flex flex-col justify-center`}>
        <div>{!small && <span className="inline-block bg-gray-100 text-gray-800 text-xs font-semibold px-2 py-1 rounded-full mb-1">{store.category}</span>}<h3 className={`font-bold text-gray-900 ${small ? 'text-sm' : ''}`}>{store.name}</h3></div>
        <p className={`text-gray-600 mt-1 line-clamp-2 ${small ? 'text-xs' : 'text-sm'}`}>{store.offer}</p>
      </div>
      <button onClick={(e) => { e.stopPropagation(); onToggleFavorite(store.id); }} className="absolute top-3 right-3 p-1.5 z-10"><Heart className={`w-6 h-6 transition-all ${isFavorite ? 'text-red-500 fill-current' : 'text-gray-300'}`} /></button>
    </div>
  </div>
);

// --- 頁面元件 ---

const HomeScreen = ({ stores, favorites, onToggleFavorite, onSelectStore }) => {
    const [searchTerm, setSearchTerm] = useState('');
    const [selectedCategory, setSelectedCategory] = useState('所有類別');
    const recommendedStores = useMemo(() => { const favoriteCategories = new Set(stores.filter(s => favorites.includes(s.id)).map(s => s.category)); return stores.filter(s => favoriteCategories.has(s.category) && !favorites.includes(s.id)).slice(0, 5); }, [stores, favorites]);
    const filteredStores = useMemo(() => { let filtered = stores; if (selectedCategory === '我的最愛') filtered = stores.filter(store => favorites.includes(store.id)); else if (selectedCategory !== '所有類別') filtered = stores.filter(store => store.category === selectedCategory); return filtered.filter(store => store.name.toLowerCase().includes(searchTerm.toLowerCase())); }, [searchTerm, selectedCategory, favorites, stores]);
    const CategoryFilter = ({ selected, onSelect }) => { const allCategories = ['我的最愛', '所有類別', ...categories]; return (<div className="flex items-center space-x-2 overflow-x-auto pb-2 -mx-4 px-4">{allCategories.map(cat => (<button key={cat} onClick={() => onSelect(cat)} className={`px-4 py-2 rounded-full text-sm font-semibold whitespace-nowrap transition-colors ${selected === cat ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700'}`}>{cat === '我的最愛' && <Heart className="w-4 h-4 inline-block mr-1" />}{cat}</button>))}</div>); };
    return (<main className="p-4 space-y-4"><div className="relative"><Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" size={20} /><input type="text" placeholder="搜尋商店名稱..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full h-11 pl-10 pr-4 bg-gray-100 border-transparent rounded-lg focus:ring-2 focus:ring-blue-500" /></div>{recommendedStores.length > 0 && (<div><h2 className="font-bold text-gray-800 mb-2">為您推薦</h2><div className="flex space-x-4 overflow-x-auto pb-2 -mx-4 px-4">{recommendedStores.map(store => <StoreCard key={store.id} store={store} onSelect={onSelectStore} isFavorite={favorites.includes(store.id)} onToggleFavorite={onToggleFavorite} small />)}</div></div>)}<CategoryFilter selected={selectedCategory} onSelect={setSelectedCategory} /><div className="space-y-3">{filteredStores.length > 0 ? filteredStores.map(store => <StoreCard key={store.id} store={store} onSelect={onSelectStore} isFavorite={favorites.includes(store.id)} onToggleFavorite={onToggleFavorite} />) : <div className="text-center py-16"><p className="text-gray-500">找不到符合條件的商店。</p></div>}</div></main>);
};

const WishlistScreen = ({ wishlist, currentUser, onWish, onAddWish }) => {
    const [wishText, setWishText] = useState('');
    const [suggestions, setSuggestions] = useState([]);
    
    const handleInputChange = (e) => {
        const value = e.target.value;
        setWishText(value);
        if (value.length > 0) {
            setSuggestions(suggestionDatabase.filter(item => item.toLowerCase().includes(value.toLowerCase())));
        } else {
            setSuggestions([]);
        }
    };

    const handleSuggestionClick = (name) => {
        setWishText(name);
        setSuggestions([]);
    };

    const handleSubmit = e => { 
        e.preventDefault(); 
        if (wishText.trim().length < 2 || !isNaN(wishText.trim())) {
            // In a real app, use a modal instead of alert.
            alert("請輸入有效的店家名稱 (至少兩個字元，且不能純為數字)");
            return;
        }
        onAddWish(wishText.trim()); 
        setWishText(''); 
    };

    return (
        <main className="p-4">
            <ul className="bg-white rounded-xl overflow-hidden border border-gray-200">{wishlist.map((item, index) => (<li key={item.id} className={`flex items-center justify-between p-4 ${index < wishlist.length - 1 ? 'border-b border-gray-200' : ''}`}><div><p className="font-semibold text-gray-800">{item.name}</p><p className="text-sm text-gray-500">{item.wishes} 人許願</p></div><button onClick={() => onWish(item.id)} disabled={item.wishedBy.includes(currentUser.id)} className={`w-24 text-white font-bold py-2 px-4 rounded-full transition-colors duration-300 flex items-center justify-center text-sm ${ item.wishedBy.includes(currentUser.id) ? 'bg-gray-300' : 'bg-yellow-500 active:bg-yellow-600'}`}><ThumbsUp size={16} className="mr-2" />{item.wishedBy.includes(currentUser.id) ? '已許願' : '+1'}</button></li>))}</ul>
            <form onSubmit={handleSubmit} className="mt-4 flex gap-2">
                <div className="relative flex-grow">
                    <input type="text" value={wishText} onChange={handleInputChange} placeholder="輸入您想要的店家..." className="w-full h-12 px-4 bg-gray-100 border-transparent rounded-lg focus:ring-2 focus:ring-blue-500"/>
                    {suggestions.length > 0 && (
                        <ul className="absolute bottom-full mb-1 w-full bg-white border rounded-lg shadow-lg max-h-40 overflow-y-auto z-10">
                           {suggestions.map(s => <li key={s} onClick={() => handleSuggestionClick(s)} className="p-2 hover:bg-gray-100 cursor-pointer">{s}</li>)}
                        </ul>
                    )}
                </div>
                <button type="submit" className="h-12 bg-green-500 text-white font-bold px-4 rounded-lg flex items-center justify-center active:bg-green-600"><PlusCircle size={20} /></button>
            </form>
        </main>
    );
};

const ProfileScreen = ({ currentUser, onSwitchUser, onCheckIn, canCheckIn, groupBuys, onViewTransactions, onViewPoints, onViewCompanyInfo, onLogout }) => (
    <main className="p-4 space-y-4">
        <div className="flex items-start space-x-4">
            <img src={currentUser.avatarUrl} alt="Employee Avatar" className="w-20 h-20 rounded-full" />
            <div className="pt-2">
                <div className="flex items-center space-x-2">
                    <h2 className="text-2xl font-bold">{currentUser.name}</h2>
                    {currentUser.status === 'pending_verification' && (
                        <span className="bg-yellow-100 text-yellow-800 text-xs font-semibold px-2.5 py-1 rounded-full">
                            未激活
                        </span>
                    )}
                </div>
                <button onClick={onViewCompanyInfo} className="text-gray-600 hover:text-blue-600 transition-colors text-left">
                    <p>{companies[currentUser.companyId]?.name || '未知公司'}</p>
                </button>
            </div>
        </div>
        <div className="bg-gradient-to-r from-blue-600 to-blue-800 text-white rounded-xl shadow-lg p-5">
            <div className="flex justify-between items-center">
                <span className="text-sm opacity-80">福利錢包餘額</span>
                <Wallet className="w-6 h-6 opacity-80" />
            </div>
            <div className="mt-2 text-4xl font-bold tracking-wider">NT$ {currentUser.walletBalance.toLocaleString()}</div>
            <div className="mt-4 flex space-x-4 text-sm">
                <button onClick={onViewTransactions} className="bg-white/20 hover:bg-white/30 w-full py-2 rounded-lg font-semibold">交易紀錄</button>
                <button className="bg-white/20 hover:bg-white/30 w-full py-2 rounded-lg font-semibold">儲值</button>
            </div>
        </div>
        <div className="bg-white rounded-xl border border-gray-200 overflow-hidden">
            <button onClick={onViewPoints} className="w-full text-left p-4 flex justify-between items-center active:bg-gray-100 transition-colors">
                <div className="flex items-center space-x-3">
                    <Award className="w-6 h-6 text-blue-500" />
                    <span className="font-semibold">我的點數</span>
                </div>
                <div className="flex items-center">
                    <span className="font-bold text-lg text-blue-800">{currentUser.points} 點</span>
                    <ChevronRight className="w-5 h-5 text-gray-400 ml-2" />
                </div>
            </button>
            <div className="border-t border-gray-200 p-4">
                <button onClick={onCheckIn} disabled={!canCheckIn} className={`font-bold py-3 rounded-lg w-full flex items-center justify-center space-x-2 transition-colors ${canCheckIn ? 'bg-green-500 text-white active:bg-green-600' : 'bg-gray-200 text-gray-500'}`}>
                    <CheckCircle />
                    <span>{canCheckIn ? '每日簽到 (+10點)' : '今日已簽到'}</span>
                </button>
            </div>
        </div>
        <button onClick={onLogout} className="bg-red-500 text-white font-bold py-3 px-6 rounded-lg w-full active:bg-red-600 flex items-center justify-center space-x-2">
            <LogOut size={20} />
            <span>登出</span>
        </button>
    </main>
);

// --- 交易紀錄頁面 ---
const TransactionHistoryScreen = ({ transactions }) => {
    const getTransactionIcon = (type) => {
        switch (type) {
            case 'purchase': return <ShoppingCart className="w-6 h-6 text-red-500" />;
            case 'topup': return <Wallet className="w-6 h-6 text-green-500" />;
            case 'groupbuy_refund': return <Users className="w-6 h-6 text-blue-500" />;
            default: return <Clock className="w-6 h-6 text-gray-500" />;
        }
    };

    const formatTimestamp = (isoString) => {
        const date = new Date(isoString);
        return date.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' });
    };

    return (
        <main className="p-4">
            {transactions.length > 0 ? (
                <ul className="bg-white rounded-xl border border-gray-200 divide-y divide-gray-200">
                    {transactions.map(tx => (
                        <li key={tx.id} className="p-4 flex items-center justify-between">
                            <div className="flex items-center space-x-4">
                                {getTransactionIcon(tx.type)}
                                <div>
                                    <p className="font-semibold text-gray-800">{tx.description}</p>
                                    <p className="text-sm text-gray-500">{formatTimestamp(tx.timestamp)}</p>
                                </div>
                            </div>
                            <p className={`font-bold text-lg ${tx.amount > 0 ? 'text-green-600' : 'text-gray-800'}`}>
                                {tx.amount > 0 ? `+${tx.amount.toLocaleString()}` : tx.amount.toLocaleString()}
                            </p>
                        </li>
                    ))}
                </ul>
            ) : (
                <div className="text-center py-20">
                    <p className="text-gray-500">目前沒有任何交易紀錄。</p>
                </div>
            )}
        </main>
    );
};

// --- 點數紀錄頁面 ---
const PointHistoryScreen = ({ pointsHistory }) => {
    const getPointIcon = (type) => {
        switch (type) {
            case 'checkin': return <CheckCircle className="w-6 h-6 text-green-500" />;
            case 'special_event': return <Gift className="w-6 h-6 text-yellow-500" />;
            default: return <Award className="w-6 h-6 text-blue-500" />;
        }
    };

    const formatTimestamp = (isoString) => {
        const date = new Date(isoString);
        return date.toLocaleDateString('zh-TW', { year: 'numeric', month: 'long', day: 'numeric' });
    };

    return (
        <main className="p-4">
            {pointsHistory.length > 0 ? (
                <ul className="bg-white rounded-xl border border-gray-200 divide-y divide-gray-200">
                    {pointsHistory.map(ph => (
                        <li key={ph.id} className="p-4 flex items-center justify-between">
                            <div className="flex items-center space-x-4">
                                {getPointIcon(ph.type)}
                                <div>
                                    <p className="font-semibold text-gray-800">{ph.description}</p>
                                    <p className="text-sm text-gray-500">{formatTimestamp(ph.timestamp)}</p>
                                </div>
                            </div>
                            <p className="font-bold text-lg text-green-600">
                                +{ph.points}
                            </p>
                        </li>
                    ))}
                </ul>
            ) : (
                <div className="text-center py-20">
                    <p className="text-gray-500">目前沒有任何點數紀錄。</p>
                </div>
            )}
        </main>
    );
};


const GroupBuyCard = ({ item, onSelect }) => {
    const { timeLeft, isEnded } = useCountdown(item.endDate);

    const timerString = () => {
        if (isEnded) return "已結束";
        
        const days = timeLeft.days > 0 ? `${timeLeft.days} 天 ` : '';
        const hours = `${String(timeLeft.hours).padStart(2, '0')}`;
        const minutes = `${String(timeLeft.minutes).padStart(2, '0')}`;
        const seconds = `${String(timeLeft.seconds).padStart(2, '0')}`;

        return `剩餘 ${days}${hours}:${minutes}:${seconds}`;
    };

    return (
        <div className={`bg-white rounded-xl border border-gray-200 overflow-hidden transition-all duration-150 ${isEnded ? 'opacity-50' : 'active:scale-95'}`} onClick={() => !isEnded && onSelect(item)}>
            <img src={item.imageUrl} alt={item.name} className="w-full h-40 object-cover" />
            <div className="p-4">
                <h3 className="font-bold text-lg truncate">{item.name}</h3>
                <div className="flex items-baseline space-x-2 mt-1">
                    <span className="text-sm font-semibold text-red-500 bg-red-100 px-2 py-1 rounded">{item.groupSize}人成團</span>
                    <p className="text-2xl font-bold text-red-500">NT${item.groupPrice}</p>
                </div>
                <p className="text-sm text-gray-500 line-through mt-1">單獨購買 NT${item.marketPrice}</p>
                 <div className={`mt-2 flex items-center text-sm ${isEnded ? 'text-gray-500' : 'text-orange-600'}`}>
                    <Clock size={16} className="mr-1.5" />
                    <span className="font-semibold">{timerString()}</span>
                </div>
            </div>
        </div>
    );
};
const GroupBuyScreen = ({ groupBuys, onSelect }) => {
    const now = new Date();
    const activeGroupBuys = groupBuys.filter(item => new Date(item.endDate) > now);
    const endedGroupBuys = groupBuys.filter(item => new Date(item.endDate) <= now);

    return (
        <main className="p-4 space-y-4">
            {activeGroupBuys.length > 0 ? (
                activeGroupBuys.map(item => <GroupBuyCard key={item.id} item={item} onSelect={onSelect} />)
            ) : (
                <div className="text-center py-16">
                    <p className="text-gray-500">目前沒有進行中的拼團活動。</p>
                </div>
            )}
            {endedGroupBuys.length > 0 && (
                <div>
                    <h3 className="text-sm font-bold text-gray-500 my-4 text-center">--- 已結束的活動 ---</h3>
                    <div className="space-y-4">
                       {endedGroupBuys.map(item => <GroupBuyCard key={item.id} item={item} onSelect={onSelect} />)}
                    </div>
                </div>
            )}
        </main>
    );
};

const AfternoonTeaScreen = ({ onSelectStore }) => (<main className="p-4 space-y-3">{teaStores.map(store => (<div key={store.id} onClick={() => onSelectStore(store)} className="bg-white rounded-xl border border-gray-200 p-4 flex items-center space-x-4 active:bg-gray-100 transition-colors cursor-pointer"><img src={store.logo} alt={store.name} className="w-16 h-16 rounded-lg" /><div><h3 className="font-bold text-lg">{store.name}</h3><p className="text-sm text-gray-500">{store.description}</p></div></div>))}</main>);

// --- 下午茶點餐頁面 ---
const TeaOrderScreen = ({ store, menu, onAddToCart }) => {
    const [selectedItem, setSelectedItem] = useState(null);

    const handleAddToCart = (item, options, quantity) => {
        onAddToCart({ ...item, options, quantity });
        setSelectedItem(null);
    };

    return (
        <main>
            <div className="p-4 flex items-center space-x-4 bg-white border-b">
                <img src={store.logo} alt={store.name} className="w-16 h-16 rounded-lg shadow-sm" />
                <div>
                    <h2 className="text-2xl font-bold">{store.name}</h2>
                    <p className="text-gray-500">{store.description}</p>
                </div>
            </div>
            <div className="p-4 grid grid-cols-1 md:grid-cols-2 gap-3">
                {menu.map(item => (
                    <div key={item.id} className="bg-white rounded-xl border border-gray-200 p-3 flex items-center space-x-3">
                        <img src={item.imageUrl} alt={item.name} className="w-20 h-20 rounded-lg object-cover" />
                        <div className="flex-grow">
                            <p className="font-semibold">{item.name}</p>
                            <p className="text-sm text-gray-500">NT$ {item.price}</p>
                        </div>
                        <button onClick={() => setSelectedItem(item)} className="p-2 rounded-full bg-blue-500 text-white active:bg-blue-600 shadow-md">
                            <Plus size={20} />
                        </button>
                    </div>
                ))}
            </div>
            {selectedItem && (
                <OptionSelector 
                    item={selectedItem} 
                    onClose={() => setSelectedItem(null)} 
                    onAddToCart={handleAddToCart} 
                />
            )}
        </main>
    );
};

// --- 品項選項選擇器 ---
const OptionSelector = ({ item, onClose, onAddToCart }) => {
    const [options, setOptions] = useState({});
    const [quantity, setQuantity] = useState(1);

    useEffect(() => {
        const defaultOptions = {};
        if (item.options) {
            Object.keys(item.options).forEach(key => {
                defaultOptions[key] = item.options[key][0];
            });
        }
        setOptions(defaultOptions);
    }, [item]);

    const totalPrice = useMemo(() => item.price * quantity, [item.price, quantity]);

    const handleSubmit = () => {
        onAddToCart(item, options, quantity);
    };

    return (
        <div className="absolute inset-0 bg-black/60 z-50 flex justify-center items-end" onClick={onClose}>
            <div 
                className="bg-white rounded-t-2xl w-full max-w-md animate-slide-in-up" 
                onClick={e => e.stopPropagation()}
            >
                <div className="p-4 border-b text-center relative">
                    <h3 className="font-bold text-lg">{item.name}</h3>
                    <button onClick={onClose} className="absolute top-1/2 -translate-y-1/2 right-4 p-1 rounded-full active:bg-gray-200"><X size={20}/></button>
                </div>
                <div className="p-4 space-y-4 max-h-[50vh] overflow-y-auto">
                    {item.options && Object.entries(item.options).map(([key, values]) => (
                        <div key={key}>
                            <h4 className="font-semibold capitalize mb-2 text-gray-800">{key === 'sugar' ? '甜度' : '冰塊'}</h4>
                            <div className="flex flex-wrap gap-2">
                                {values.map(value => (
                                    <button 
                                        key={value} 
                                        onClick={() => setOptions({...options, [key]: value})} 
                                        className={`px-4 py-2 rounded-full text-sm font-semibold transition-colors ${options[key] === value ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-800'}`}
                                    >
                                        {value}
                                    </button>
                                ))}
                            </div>
                        </div>
                    ))}
                </div>
                <div className="p-4 border-t flex items-center justify-between">
                     <div className="flex items-center space-x-3">
                        <button onClick={() => setQuantity(q => Math.max(1, q - 1))} className="p-2 rounded-full bg-gray-200 active:bg-gray-300"><Minus size={16} /></button>
                        <span className="font-bold text-lg w-8 text-center">{quantity}</span>
                        <button onClick={() => setQuantity(q => q + 1)} className="p-2 rounded-full bg-gray-200 active:bg-gray-300"><Plus size={16} /></button>
                    </div>
                    <button onClick={handleSubmit} className="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg w-1/2">
                        加入 - NT$ {totalPrice}
                    </button>
                </div>
            </div>
        </div>
    );
};


const CartModal = ({ cart, setCart, user, onCheckout, onClose }) => {
    const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    
    // 移除購物車項目
    const handleRemoveItem = (cartId) => {
        setCart(currentCart => currentCart.filter(item => item.cartId !== cartId));
    };

    return (
        <div className="absolute inset-0 bg-black/60 z-50 flex justify-center items-end animate-fade-in" onClick={onClose}>
            <div className="bg-white rounded-t-2xl w-full max-w-lg animate-slide-in-up" onClick={e => e.stopPropagation()}>
                <div className="p-4 border-b text-center relative">
                    <h2 className="font-bold text-lg">您的訂單</h2>
                    <button onClick={onClose} className="absolute top-1/2 -translate-y-1/2 right-4"><X /></button>
                </div>
                <div className="p-4 max-h-60 overflow-y-auto">
                    {cart.length > 0 ? cart.map((item) => (
                        <div key={item.cartId} className="flex items-center justify-between py-2">
                            <div>
                                <p className="font-semibold">{item.name} <span className="font-normal text-gray-600">x{item.quantity}</span></p>
                                <p className="text-sm text-gray-500">{Object.values(item.options).join(', ')}</p>
                            </div>
                            <div className="flex items-center space-x-3">
                                <p>NT$ {item.price * item.quantity}</p>
                                <button onClick={() => handleRemoveItem(item.cartId)} className="text-red-500 p-1"><X size={16} /></button>
                            </div>
                        </div>
                    )) : <p className="text-center text-gray-500 py-4">您的購物車是空的</p>}
                </div>
                <div className="p-4 border-t space-y-3">
                    <div className="flex justify-between font-semibold"><span>福利錢包餘額</span><span>NT$ {user.walletBalance}</span></div>
                    <div className="flex justify-between font-bold text-xl"><span>總計</span><span>NT$ {total}</span></div>
                    <button onClick={() => onCheckout(total)} disabled={user.walletBalance < total || cart.length === 0} className="w-full bg-blue-600 text-white font-bold py-3 rounded-lg disabled:bg-gray-400">
                        {user.walletBalance >= total ? '確認付款' : '餘額不足'}
                    </button>
                </div>
            </div>
        </div>
    );
};

const GroupBuyDetailModal = ({ item, user, onClose, onStartPing, onJoinPing, activePings }) => {
      if (!item) return null;
      const userPing = activePings.find(p => p.itemId === item.id && p.members.includes(user.id));

      if (userPing) {
          return <PingStatusModal ping={userPing} item={item} user={user} onClose={onClose} />;
      }
      
      const availablePings = activePings.filter(p => p.itemId === item.id && p.members.length < item.groupSize);

      return (
          <div className="absolute inset-0 bg-white z-50 animate-fade-in">
              <div className="h-full w-full flex flex-col">
                  <div className="bg-white sticky top-0 z-10 border-b border-gray-200"><div className="px-4 h-14 flex items-center justify-between"><button onClick={onClose} className="text-blue-600 font-semibold">取消</button><h2 className="font-bold text-gray-800">商品詳情</h2><div className="w-12"></div></div></div>
                  <div className="flex-grow overflow-y-auto">
                      <img src={item.imageUrl} alt={item.name} className="w-full h-64 object-cover" />
                      <div className="p-4">
                          <h2 className="text-3xl font-bold">{item.name}</h2>
                          <p className="text-gray-700 mt-4">{item.description}</p>
                      </div>
                      {availablePings.length > 0 && (
                          <div className="p-4">
                              <h3 className="font-bold mb-2">進行中的團 (可直接加入)</h3>
                              <div className="space-y-2">{availablePings.map(ping => <PingJoinCard key={ping.id} ping={ping} item={item} onJoinPing={onJoinPing} />)}</div>
                          </div>
                      )}
                  </div>
                  <div className="p-4 bg-white border-t grid grid-cols-2 gap-2">
                      <button className="bg-gray-200 text-gray-800 font-bold py-3 rounded-lg flex flex-col items-center"><span>NT$ {item.marketPrice}</span><span className="text-xs">單獨購買</span></button>
                      <button onClick={() => onStartPing(item.id)} className="bg-red-500 text-white font-bold py-3 rounded-lg flex flex-col items-center"><span>NT$ {item.groupPrice}</span><span className="text-xs">{item.groupSize}人拼團</span></button>
                  </div>
              </div>
          </div>
      );
};

const PingJoinCard = ({ ping, item, onJoinPing }) => {
    const leader = users[ping.leader];
    const { timeLeft, isEnded } = useCountdown(ping.endDate);
    if (isEnded) return null;

    const daysText = timeLeft.days > 0 ? `${timeLeft.days}天 ` : '';
    const hoursText = `${String(timeLeft.hours).padStart(2, '0')}`;
    const minutesText = `${String(timeLeft.minutes).padStart(2, '0')}`;
    const secondsText = `${String(timeLeft.seconds).padStart(2, '0')}`;
    const countdownText = `剩餘 ${daysText}${hoursText}:${minutesText}:${secondsText}`;

    return (
        <div className="bg-gray-100 rounded-lg p-3 flex items-center justify-between">
            <div className="flex items-center">
                <img src={leader.avatarUrl} className="w-10 h-10 rounded-full" />
                <div className="ml-3">
                    <p className="font-semibold">{leader.name} 的團</p>
                    <p className="text-xs text-gray-500">還差 {item.groupSize - ping.members.length} 人，{countdownText}</p>
                </div>
            </div>
            <button onClick={() => onJoinPing(ping.id)} className="bg-red-500 text-white font-bold px-4 py-2 rounded-lg text-sm">加入</button>
        </div>
    );
};

const PingStatusModal = ({ ping, item, user, onClose }) => {
    const { timeLeft, isEnded } = useCountdown(ping.endDate);
    const isSuccess = ping.members.length >= item.groupSize;
    const handleShare = () => {
        // In a real app, use navigator.clipboard
        alert(`已複製拼團連結！\n快來加入 ${users[ping.leader].name} 開的「${item.name}」團！還差 ${item.groupSize - ping.members.length} 人！`);
    }

    const daysText = timeLeft.days > 0 ? `${timeLeft.days}天 ` : '';
    const hoursText = `${String(timeLeft.hours).padStart(2, '0')}`;
    const minutesText = `${String(timeLeft.minutes).padStart(2, '0')}`;
    const secondsText = `${String(timeLeft.seconds).padStart(2, '0')}`;
    const countdownText = `${daysText}${hoursText}:${minutesText}:${secondsText}`;

    return (
        <div className="absolute inset-0 bg-white z-50 animate-fade-in">
            <div className="h-full w-full flex flex-col items-center p-4">
                <div className="w-full flex justify-end"><button onClick={onClose} className="text-blue-600 font-semibold">完成</button></div>
                <div className="text-center mt-8">
                    <h2 className="text-2xl font-bold">{isSuccess ? "拼團成功！" : isEnded ? "拼團失敗" : "拼團中..."}</h2>
                    <p className="text-gray-600 mt-2">{isSuccess ? "已為您成立訂單" : isEnded ? "已將款項退回您的錢包" : `還差 ${item.groupSize - ping.members.length} 人，快邀請同事加入！`}</p>
                    <div className="mt-4 font-semibold text-2xl text-red-500">{isEnded || isSuccess ? "" : countdownText}</div>
                </div>
                <div className="my-8 flex items-center space-x-2">
                    {ping.members.map(memberId => <img key={memberId} src={users[memberId].avatarUrl} className="w-12 h-12 rounded-full border-2 border-white" />)}
                    {[...Array(item.groupSize - ping.members.length)].map((_, i) => <div key={i} className="w-12 h-12 rounded-full bg-gray-200 border-2 border-dashed flex items-center justify-center"><User className="text-gray-400" /></div>)}
                </div>
                <div className="w-full max-w-sm">
                    <button onClick={handleShare} disabled={isSuccess || isEnded} className="w-full bg-red-500 text-white font-bold py-4 rounded-lg text-lg disabled:bg-gray-400">邀請同事加入</button>
                </div>
            </div>
        </div>
    );
};

// --- 公司資訊彈窗 ---
const CompanyInfoModal = ({ company, onClose }) => {
    if (!company) return null;

    return (
        <div className="absolute inset-0 bg-black/60 z-50 flex justify-center items-center p-4" onClick={onClose}>
            <div
                className="bg-white rounded-2xl w-full max-w-sm animate-fade-in-up"
                onClick={e => e.stopPropagation()}
            >
                <div className="p-4 border-b text-center relative">
                    <h3 className="font-bold text-lg">公司資訊</h3>
                    <button onClick={onClose} className="absolute top-1/2 -translate-y-1/2 right-4 p-1 rounded-full active:bg-gray-200"><X size={20}/></button>
                </div>
                <div className="p-6 space-y-4">
                    <div className="flex items-start space-x-3">
                        <Building className="w-5 h-5 text-gray-500 mt-1 flex-shrink-0" />
                        <div>
                            <p className="text-sm text-gray-500">公司名稱</p>
                            <p className="font-semibold">{company.name}</p>
                        </div>
                    </div>
                    <div className="flex items-start space-x-3">
                        <MapPin className="w-5 h-5 text-gray-500 mt-1 flex-shrink-0" />
                        <div>
                            <p className="text-sm text-gray-500">公司地址</p>
                            <p className="font-semibold">{company.address}</p>
                        </div>
                    </div>
                    <div className="flex items-start space-x-3">
                        <Phone className="w-5 h-5 text-gray-500 mt-1 flex-shrink-0" />
                        <div>
                            <p className="text-sm text-gray-500">連絡電話</p>
                            <p className="font-semibold">{company.phone}</p>
                        </div>
                    </div>
                    <div className="flex items-start space-x-3">
                        <Tag className="w-5 h-5 text-gray-500 mt-1 flex-shrink-0" />
                        <div>
                            <p className="text-sm text-gray-500">福委會編號</p>
                            <p className="font-semibold">{company.welfareId}</p>
                        </div>
                    </div>
                </div>
                 <div className="p-4 bg-gray-50 rounded-b-2xl">
                    <button onClick={onClose} className="w-full bg-blue-600 text-white font-bold py-3 rounded-lg active:bg-blue-700">
                        關閉
                    </button>
                </div>
            </div>
        </div>
    );
};

// --- 登入/註冊頁面 ---
const AuthScreen = ({ onAuthSuccess }) => {
    const [isLogin, setIsLogin] = useState(true);
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [error, setError] = useState('');
    const [isLoading, setIsLoading] = useState(false);

    const handleAuthAction = async (e) => {
        e.preventDefault();
        setIsLoading(true);
        setError('');
        try {
            if (isLogin) {
                await signInWithEmailAndPassword(auth, email, password);
            } else {
                await createUserWithEmailAndPassword(auth, email, password);
            }
            // onAuthStateChanged 會處理後續邏輯
        } catch (err) {
            setError(err.message);
        } finally {
            setIsLoading(false);
        }
    };

    return (
        <div className="flex flex-col items-center justify-center h-full p-8 bg-gray-50">
            <h1 className="text-3xl font-bold text-blue-600 mb-2">企業福利平台</h1>
            <p className="text-gray-500 mb-8">{isLogin ? '登入您的帳戶' : '建立一個新帳戶'}</p>
            <form onSubmit={handleAuthAction} className="w-full space-y-4">
                <input
                    type="email"
                    value={email}
                    onChange={(e) => setEmail(e.target.value)}
                    placeholder="電子郵件"
                    className="w-full h-12 px-4 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    required
                />
                <input
                    type="password"
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    placeholder="密碼"
                    className="w-full h-12 px-4 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    required
                />
                {error && <p className="text-red-500 text-sm text-center">{error}</p>}
                <button
                    type="submit"
                    disabled={isLoading}
                    className="w-full bg-blue-600 text-white font-bold py-3 rounded-lg active:bg-blue-700 disabled:bg-gray-400 flex items-center justify-center"
                >
                    {isLoading && <Loader2 className="w-5 h-5 mr-2 animate-spin" />}
                    {isLogin ? '登入' : '註冊'}
                </button>
            </form>
            <button onClick={() => setIsLogin(!isLogin)} className="mt-4 text-sm text-blue-600 hover:underline">
                {isLogin ? '還沒有帳戶嗎？註冊一個' : '已經有帳戶了？直接登入'}
            </button>
        </div>
    );
};

// --- 新用戶註冊資料頁面 ---
const RegistrationScreen = ({ firebaseUser, onRegistrationComplete }) => {
    const [name, setName] = useState('');
    const [phone, setPhone] = useState('');
    const [companyId, setCompanyId] = useState('');
    const [companySearch, setCompanySearch] = useState('');
    const [companySuggestions, setCompanySuggestions] = useState([]);
    const [isLoading, setIsLoading] = useState(false);
    const [error, setError] = useState('');

    const handleCompanySearch = (e) => {
        const query = e.target.value;
        setCompanySearch(query);
        setCompanyId(''); // 清除已選定的公司
        if (query.length > 0) {
            const suggestions = Object.values(companies).filter(c => 
                c.name.toLowerCase().includes(query.toLowerCase())
            );
            setCompanySuggestions(suggestions);
        } else {
            setCompanySuggestions([]);
        }
    };

    const selectCompany = (company) => {
        setCompanyId(company.id);
        setCompanySearch(company.name);
        setCompanySuggestions([]);
    };

    const handleSubmit = async (e) => {
        e.preventDefault();
        if (!name.trim() || !phone.trim() || !companyId) {
            setError('所有欄位皆為必填，且需從列表中選擇一間公司');
            return;
        }
        setIsLoading(true);
        setError('');

        const newUserProfile = {
            name: name.trim(),
            phone: phone.trim(),
            companyId,
            email: firebaseUser.email,
            avatarUrl: `https://placehold.co/100x100/CCCCCC/FFFFFF?text=${name.trim()[0]}`,
            favorites: [],
            points: 100, // 新用戶獎勵點數
            lastCheckIn: '',
            walletBalance: 0,
            status: 'pending_verification', // 新增狀態欄位
        };

        try {
            await setDoc(doc(db, "users", firebaseUser.uid), newUserProfile);
            onRegistrationComplete({ id: firebaseUser.uid, ...newUserProfile });
        } catch (err) {
            console.error("寫入使用者資料失敗:", err);
            setError("儲存資料失敗，請稍後再試。");
            setIsLoading(false);
        }
    };

    return (
        <div className="flex flex-col h-full p-8 bg-gray-50">
            <h1 className="text-3xl font-bold text-blue-600 mb-2">建立個人檔案</h1>
            <p className="text-gray-500 mb-8">只差一步！請完成您的個人資料。</p>
            <form onSubmit={handleSubmit} className="w-full space-y-4 flex-grow flex flex-col">
                <div className="space-y-4">
                    <input
                        type="text"
                        value={name}
                        onChange={(e) => setName(e.target.value)}
                        placeholder="姓名"
                        className="w-full h-12 px-4 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        required
                    />
                    <input
                        type="tel"
                        value={phone}
                        onChange={(e) => setPhone(e.target.value)}
                        placeholder="電話號碼"
                        className="w-full h-12 px-4 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                        required
                    />
                    <div className="relative">
                        <input
                            type="text"
                            value={companySearch}
                            onChange={handleCompanySearch}
                            placeholder="輸入公司名稱搜尋"
                            className="w-full h-12 px-4 bg-white border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                            required
                        />
                        {companySuggestions.length > 0 && (
                            <ul className="absolute top-full mt-1 w-full bg-white border rounded-lg shadow-lg max-h-40 overflow-y-auto z-10">
                                {companySuggestions.map(c => (
                                    <li 
                                        key={c.id} 
                                        onClick={() => selectCompany(c)} 
                                        className="p-3 hover:bg-gray-100 cursor-pointer text-sm"
                                    >
                                        {c.name}
                                    </li>
                                ))}
                            </ul>
                        )}
                    </div>
                </div>
                {error && <p className="text-red-500 text-sm text-center">{error}</p>}
                <div className="mt-auto">
                    <button
                        type="submit"
                        disabled={isLoading}
                        className="w-full bg-blue-600 text-white font-bold py-3 rounded-lg active:bg-blue-700 disabled:bg-gray-400 flex items-center justify-center"
                    >
                        {isLoading && <Loader2 className="w-5 h-5 mr-2 animate-spin" />}
                        完成註冊
                    </button>
                </div>
            </form>
        </div>
    );
};


// --- 主應用程式元件 ---
export default function App() {
  const [activeTab, setActiveTab] = useState('home');
  const [currentUser, setCurrentUser] = useState(null);
  const [firebaseUser, setFirebaseUser] = useState(null);
  const [isProfileIncomplete, setIsProfileIncomplete] = useState(false);
  const [selectedTeaStore, setSelectedTeaStore] = useState(null);
  const [cart, setCart] = useState([]);
  const [isCartOpen, setIsCartOpen] = useState(false);
  const [groupBuys, setGroupBuys] = useState(initialGroupBuys);
  const [selectedGroupBuy, setSelectedGroupBuy] = useState(null);
  const [favorites, setFavorites] = useState([]);
  const [wishlist, setWishlist] = useState(initialWishlist);
  const [notifications, setNotifications] = useState(initialNotifications);
  const [transactions, setTransactions] = useState({});
  const [pointsHistory, setPointsHistory] = useState({});
  const [isViewingTransactions, setIsViewingTransactions] = useState(false);
  const [isViewingPoints, setIsViewingPoints] = useState(false);
  const [isCompanyInfoOpen, setIsCompanyInfoOpen] = useState(false);
  const [activePings, setActivePings] = useState([
      { id: 'ping-1', itemId: 'gb-2', leader: 'user-2', members: ['user-2'], endDate: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString() }
  ]);
  const [stores, setStores] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  
  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, async (user) => {
      setIsLoading(true);
      if (user) {
        setFirebaseUser(user);
        const userDocRef = doc(db, "users", user.uid);
        const userDocSnap = await getDoc(userDocRef);
        if (userDocSnap.exists() && userDocSnap.data().name) {
          setCurrentUser({ id: user.uid, ...userDocSnap.data() });
          setIsProfileIncomplete(false);
        } else {
          setIsProfileIncomplete(true);
          setCurrentUser(null);
        }
      } else {
        setFirebaseUser(null);
        setCurrentUser(null);
        setIsProfileIncomplete(false);
      }
      setIsLoading(false);
    });
    return () => unsubscribe();
  }, []);

  useEffect(() => {
    const fetchStores = async () => {
      try {
        await new Promise(resolve => setTimeout(resolve, 1000));
        const mockStores = [
          { id: 1, name: '星巴克 Starbucks', category: '美食餐飲', offer: '憑 App QR Code，所有飲品享第二杯半價優惠。', location: '全台門市', logo: 'https://placehold.co/100x100/036635/FFFFFF?text=Starbucks', details: '此優惠不適用於外送平台、預訂服務。不可與其他優惠合併使用。' },
          { id: 2, name: '威秀影城 Vieshow Cinemas', category: '休閒娛樂', offer: '出示 App QR Code，享 2D 電影票 NT$240 優惠價。', location: '全台據點', logo: 'https://placehold.co/100x100/ED1C24/FFFFFF?text=Vieshow', details: '每證每日限購 4 張。不適用於 3D、IMAX、特殊影廳。詳細辦法依影城公告為準。' },
        ];
        setStores(mockStores);
      } catch (error) {
        console.error("讀取商店資料失敗:", error);
      }
    };

    if (firebaseUser && !isProfileIncomplete) {
        fetchStores();
    }
  }, [firebaseUser, isProfileIncomplete]);

  const handleRegistrationComplete = (newProfile) => {
      setCurrentUser(newProfile);
      setIsProfileIncomplete(false);
  };

  const handleLogout = async () => {
    await signOut(auth);
  };

  const handleStartPing = (itemId) => {
      const newPing = { id: `ping-${Date.now()}`, itemId: itemId, leader: currentUser.id, members: [currentUser.id], endDate: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString() };
      setActivePings([...activePings, newPing]);
  };

  const handleJoinPing = (pingId) => {
      setActivePings(pings => pings.map(p => p.id === pingId ? { ...p, members: [...p.members, currentUser.id] } : p));
  };

  const today = new Date().toISOString().slice(0, 10);
  const canCheckIn = currentUser?.lastCheckIn !== today;
  
  const handleCheckIn = () => { 
      if (canCheckIn) {
          const newPointRecord = {
              id: `p-${Date.now()}`,
              type: 'checkin',
              description: '每日簽到',
              points: 10,
              timestamp: new Date().toISOString()
          };
          setPointsHistory(prev => ({
              ...prev,
              [currentUser.id]: [newPointRecord, ...(prev[currentUser.id] || [])]
          }));
          setCurrentUser({ ...currentUser, points: currentUser.points + 10, lastCheckIn: today }); 
      }
  };

  const handleMarkAllRead = () => setNotifications(notifications.map(n => ({ ...n, read: true })));
  const handleToggleFavorite = storeId => setFavorites(prev => prev.includes(storeId) ? prev.filter(id => id !== storeId) : [...prev, storeId]);
  const handleWish = id => setWishlist(currentWishlist => currentWishlist.map(item => item.id === id && !item.wishedBy.includes(currentUser.id) ? { ...item, wishes: item.wishes + 1, wishedBy: [...item.wishedBy, currentUser.id] } : item).sort((a, b) => b.wishes - a.wishes));
  const handleAddWish = wishText => setWishlist(prev => [{ id: Date.now(), name: wishText, category: '其他', wishes: 1, wishedBy: [currentUser.id] }, ...prev].sort((a, b) => b.wishes - a.wishes));
  const handleJoinGroupBuy = id => setGroupBuys(prev => prev.map(item => item.id === id && !(item.joinedBy || []).includes(currentUser.id) ? { ...item, current: item.current + 1, joinedBy: [...(item.joinedBy || []), currentUser.id] } : item));
  
  const handleAddToCart = (itemToAdd) => {
    setCart(prevCart => [...prevCart, { ...itemToAdd, cartId: Date.now() }]);
  };

  const handleCheckout = (total) => { 
    if (currentUser.walletBalance < total) {
        alert('餘額不足！');
        return;
    }

    const newTransaction = {
        id: `t-${Date.now()}`,
        type: 'purchase',
        description: cart.map(item => `${item.name} x${item.quantity}`).join(', '),
        amount: -total,
        timestamp: new Date().toISOString()
    };
    
    setTransactions(prev => ({
        ...prev,
        [currentUser.id]: [newTransaction, ...(prev[currentUser.id] || [])]
    }));

    setCurrentUser({...currentUser, walletBalance: currentUser.walletBalance - total}); 
    setCart([]); 
    setIsCartOpen(false); 
    alert('訂購成功！'); 
    setSelectedTeaStore(null); 
    setActiveTab('home');
  };

  if (isLoading) {
    return (
      <div className="bg-gray-100 min-h-screen font-sans flex justify-center items-center p-4">
        <div className="w-full max-w-md mx-auto bg-white shadow-lg rounded-3xl border-8 border-black relative h-[800px] flex flex-col overflow-hidden">
          <div className="flex flex-col items-center justify-center h-full">
            <Loader2 className="w-12 h-12 text-blue-500 animate-spin" />
            <p className="mt-4 text-gray-500">正在載入...</p>
          </div>
        </div>
      </div>
    );
  }

  if (!firebaseUser) {
    return (
      <div className="bg-gray-100 min-h-screen font-sans flex justify-center items-center p-4">
        <div className="w-full max-w-md mx-auto bg-white shadow-lg rounded-3xl border-8 border-black relative h-[800px] flex flex-col overflow-hidden">
          <AuthScreen />
        </div>
      </div>
    );
  }
  
  if (isProfileIncomplete) {
     return (
      <div className="bg-gray-100 min-h-screen font-sans flex justify-center items-center p-4">
        <div className="w-full max-w-md mx-auto bg-white shadow-lg rounded-3xl border-8 border-black relative h-[800px] flex flex-col overflow-hidden">
          <RegistrationScreen firebaseUser={firebaseUser} onRegistrationComplete={handleRegistrationComplete} />
        </div>
      </div>
    );
  }


  const renderContent = () => {
    if (isViewingTransactions) {
        return <TransactionHistoryScreen transactions={transactions[currentUser.id] || []} />;
    }
    if (isViewingPoints) {
        return <PointHistoryScreen pointsHistory={pointsHistory[currentUser.id] || []} />;
    }
    if (selectedTeaStore) {
        return <TeaOrderScreen store={selectedTeaStore} menu={sampleMenu[selectedTeaStore.id]} onAddToCart={handleAddToCart} />;
    }
    
    let content;
    switch(activeTab) {
        case 'home': content = <HomeScreen stores={stores} favorites={favorites} onToggleFavorite={handleToggleFavorite} onSelectStore={() => {}} />; break;
        case 'groupbuy': content = <GroupBuyScreen groupBuys={groupBuys} onSelect={setSelectedGroupBuy} />; break;
        case 'tea': content = <AfternoonTeaScreen onSelectStore={setSelectedTeaStore} />; break;
        case 'wishlist': content = <WishlistScreen wishlist={wishlist} currentUser={currentUser} onWish={handleWish} onAddWish={handleAddWish} />; break;
        case 'profile': content = <ProfileScreen currentUser={currentUser} onCheckIn={handleCheckIn} canCheckIn={canCheckIn} groupBuys={groupBuys} onViewTransactions={() => setIsViewingTransactions(true)} onViewPoints={() => setIsViewingPoints(true)} onViewCompanyInfo={() => setIsCompanyInfoOpen(true)} onLogout={handleLogout} />; break;
        default: content = <HomeScreen stores={stores} favorites={favorites} onToggleFavorite={handleToggleFavorite} onSelectStore={() => {}} />;
    }
    return <div key={activeTab} className="animate-fade-in">{content}</div>;
  };

  const getTitle = () => {
      if (isViewingTransactions) return '交易紀錄';
      if (isViewingPoints) return '點數紀錄';
      if (selectedTeaStore) return selectedTeaStore.name;
      return { home: '特約商店', groupbuy: '社交拼團', tea: '訂下午茶', wishlist: '許願池', profile: '我的帳號' }[activeTab];
  };
  
  const showBackButton = isViewingTransactions || isViewingPoints || !!selectedTeaStore || activeTab === 'profile';

  const handleBack = () => {
      if (isViewingTransactions) {
          setIsViewingTransactions(false);
      } else if (isViewingPoints) {
          setIsViewingPoints(false);
      } else if (selectedTeaStore) {
          setSelectedTeaStore(null);
      } else if (activeTab === 'profile') {
          setActiveTab('home');
      }
  };

  return (
    <div className="bg-gray-100 min-h-screen font-sans flex justify-center items-center p-4">
      <div className="w-full max-w-md mx-auto bg-white shadow-lg rounded-3xl border-8 border-black relative h-[800px] flex flex-col overflow-hidden">
        <AppHeader 
          title={getTitle()} 
          onBack={handleBack}
          showBackButton={showBackButton} 
          notifications={notifications} 
          onMarkAllRead={handleMarkAllRead}
          onProfileClick={() => {
              setIsViewingTransactions(false);
              setIsViewingPoints(false);
              setSelectedTeaStore(null);
              setActiveTab('profile');
          }}
        />
        <div className="flex-grow overflow-y-auto">
            <div className="pb-16">
                {renderContent()}
            </div>
        </div>
        {activeTab !== 'profile' && !selectedTeaStore && !isViewingTransactions && !isViewingPoints && <BottomNavBar activeTab={activeTab} setActiveTab={setActiveTab} />}
        {cart.length > 0 && !isCartOpen && (<div className="absolute bottom-20 right-4 z-30"><button onClick={() => setIsCartOpen(true)} className="bg-blue-600 text-white rounded-full shadow-lg p-4 flex items-center space-x-2 animate-bounce"><ShoppingCart /><span className="font-bold">{cart.reduce((acc, item) => acc + item.quantity, 0)}</span></button></div>)}
        {isCartOpen && <CartModal cart={cart} setCart={setCart} user={currentUser} onCheckout={handleCheckout} onClose={() => setIsCartOpen(false)} />}
        <GroupBuyDetailModal item={selectedGroupBuy} user={currentUser} onClose={() => setSelectedGroupBuy(null)} onStartPing={handleStartPing} onJoinPing={handleJoinPing} activePings={activePings} />
        {isCompanyInfoOpen && <CompanyInfoModal company={companies[currentUser.companyId]} onClose={() => setIsCompanyInfoOpen(false)} />}
      </div>
    </div>
  );
}
