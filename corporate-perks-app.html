import React, { useState, useMemo, useEffect } from 'react';
import { Search, MapPin, Building, X, ThumbsUp, Star, QrCode, ArrowLeft, Users, Heart, PlusCircle, Home, Gift, User, Bell, Tag, Share2, CheckCircle, Award } from 'lucide-react';

// --- Mock Data (Platform Model) ---
const companies = {
  'company-a': { id: 'company-a', name: '卓越科技有限公司' },
  'company-b': { id: 'company-b', name: '創新國際股份有限公司' },
};

const users = {
  'user-1': { id: 'user-1', name: '王大明', companyId: 'company-a', avatarUrl: 'https://placehold.co/100x100/7F9CF5/FFFFFF?text=王', favorites: [2, 4], points: 1250, lastCheckIn: '2025-08-19' },
  'user-2': { id: 'user-2', name: '陳小美', companyId: 'company-b', avatarUrl: 'https://placehold.co/100x100/F5A623/FFFFFF?text=陳', favorites: [1], points: 800, lastCheckIn: '2025-08-20' },
};

const categories = ['美食餐飲', '休閒娛樂', '生活百貨', '美容美髮', '交通出行', '學習成長'];

const stores = [
  { id: 1, name: '星巴克 Starbucks', category: '美食餐飲', offer: '憑 App QR Code，所有飲品享第二杯半價優惠。', location: '全台門市', logo: 'https://placehold.co/100x100/036635/FFFFFF?text=Starbucks', details: '此優惠不適用於外送平台、預訂服務。不可與其他優惠合併使用。' },
  { id: 2, name: '威秀影城 Vieshow Cinemas', category: '休閒娛樂', offer: '出示 App QR Code，享 2D 電影票 NT$240 優惠價。', location: '全台據點', logo: 'https://placehold.co/100x100/ED1C24/FFFFFF?text=Vieshow', details: '每證每日限購 4 張。不適用於 3D、IMAX、特殊影廳。詳細辦法依影城公告為準。' },
  { id: 3, name: '誠品生活 Eslite Spectrum', category: '生活百貨', offer: '當日單筆消費滿千，享 95 折優惠。', location: '指定門市', logo: 'https://placehold.co/100x100/000000/FFFFFF?text=Eslite', details: '部分專櫃、特價品、書店及餐飲不適用。詳情請洽詢現場服務人員。' },
  { id: 4, name: 'World Gym 世界健身俱樂部', category: '休閒娛樂', offer: '企業員工免入會費，月費享 8 折。', location: '全台據點', logo: 'https://placehold.co/100x100/D42E1E/FFFFFF?text=WG', details: '需簽訂至少一年合約。需提供在職證明。' },
];

const initialWishlist = [
    { id: 1, name: '海底撈火鍋', category: '美食餐飲', wishes: 128, wishedBy: [] },
    { id: 2, name: 'Uniqlo 優衣庫', category: '生活百貨', wishes: 94, wishedBy: ['user-1'] },
    { id: 3, name: '台灣高鐵', category: '交通出行', wishes: 85, wishedBy: [] },
];

const initialNotifications = [
  { id: 1, type: 'new_store', title: '新店家加入！', content: '知名連鎖咖啡廳「Cama Café」已加入我們的特約行列！', timestamp: '2 小時前', read: false },
  { id: 2, type: 'offer', title: '限時優惠提醒', content: '威秀影城本週末電影票優惠，只到 8/22！', timestamp: '1 天前', read: false },
  { id: 3, type: 'wishlist', title: '許願池更新', content: '您許願的「海底撈火鍋」已有超過 100 人支持！', timestamp: '3 天前', read: true },
];

// --- Native-style Components ---

const AppHeader = ({ title, notifications, onMarkAllRead }) => {
    const [panelOpen, setPanelOpen] = useState(false);
    const unreadCount = notifications.filter(n => !n.read).length;

    return (
        <header className="bg-white/80 backdrop-blur-lg sticky top-0 z-20 border-b border-gray-200">
            <div className="px-4 h-14 flex items-center justify-between">
                <h1 className="text-lg font-bold text-gray-900">{title}</h1>
                <div className="relative">
                    <button onClick={() => setPanelOpen(!panelOpen)} className="relative p-2 rounded-full hover:bg-gray-200">
                        <Bell className="w-6 h-6 text-gray-600" />
                        {unreadCount > 0 && <span className="absolute top-1 right-1 block h-2.5 w-2.5 rounded-full bg-red-500 border-2 border-white"></span>}
                    </button>
                    {panelOpen && <NotificationPanel notifications={notifications} onClose={() => setPanelOpen(false)} onMarkAllRead={() => { onMarkAllRead(); setPanelOpen(false); }} />}
                </div>
            </div>
        </header>
    );
};

const NotificationPanel = ({ notifications, onMarkAllRead }) => {
    const getIconForType = type => ({ new_store: <Building className="w-5 h-5 text-green-500" />, offer: <Tag className="w-5 h-5 text-red-500" />, wishlist: <Gift className="w-5 h-5 text-yellow-500" /> }[type] || <Bell className="w-5 h-5 text-gray-500" />);
    return (
        <div className="absolute top-full right-0 mt-2 w-80 bg-white rounded-lg shadow-xl border border-gray-200 z-30 animate-fade-in-down">
            <div className="p-3 flex justify-between items-center border-b"><h3 className="font-bold">通知中心</h3><button onClick={onMarkAllRead} className="text-xs text-blue-600 font-semibold">全部已讀</button></div>
            <div className="max-h-96 overflow-y-auto">
                {notifications.length > 0 ? notifications.map(notif => (
                    <div key={notif.id} className={`p-3 flex items-start space-x-3 border-b ${!notif.read ? 'bg-blue-50' : 'bg-white'}`}>
                        <div className="flex-shrink-0 mt-1">{getIconForType(notif.type)}</div>
                        <div><p className="font-semibold text-sm">{notif.title}</p><p className="text-xs text-gray-600">{notif.content}</p><p className="text-xs text-gray-400 mt-1">{notif.timestamp}</p></div>
                    </div>
                )) : <p className="p-4 text-sm text-gray-500 text-center">沒有新的通知</p>}
            </div>
        </div>
    );
};

const BottomNavBar = ({ activeTab, setActiveTab }) => {
    const navItems = [{ id: 'home', icon: Home, label: '主頁' }, { id: 'wishlist', icon: Gift, label: '許願池' }, { id: 'profile', icon: User, label: '個人' }];
    return (
        <footer className="bg-white/80 backdrop-blur-lg fixed bottom-0 left-0 right-0 z-20 border-t border-gray-200">
            <div className="flex justify-around items-center h-16">{navItems.map(item => (<button key={item.id} onClick={() => setActiveTab(item.id)} className={`flex flex-col items-center justify-center space-y-1 w-full ${activeTab === item.id ? 'text-blue-600' : 'text-gray-500'}`}><item.icon className="w-6 h-6" /><span className="text-xs font-medium">{item.label}</span></button>))}</div>
        </footer>
    );
};

const StoreCard = ({ store, onSelect, isFavorite, onToggleFavorite, small = false }) => (
  <div className={`bg-white rounded-xl shadow-md overflow-hidden transform active:scale-95 transition-transform duration-150 ${small ? 'w-48' : ''}`} onClick={() => onSelect(store)}>
    <div className={`flex ${small ? 'flex-col' : 'p-3'}`}>
      <img src={store.logo} alt={`${store.name} logo`} className={`${small ? 'w-full h-24' : 'w-20 h-20 rounded-lg'} flex-shrink-0 object-cover`} />
      <div className={`${small ? 'p-2' : 'ml-4'} flex flex-col justify-center`}>
        <div>
          { !small && <span className="inline-block bg-blue-100 text-blue-800 text-xs font-semibold px-2 py-1 rounded-full mb-1">{store.category}</span> }
          <h3 className={`font-bold text-gray-900 ${small ? 'text-sm' : ''}`}>{store.name}</h3>
        </div>
        <p className={`text-gray-600 mt-1 line-clamp-2 ${small ? 'text-xs' : 'text-sm'}`}>{store.offer}</p>
      </div>
      <button onClick={(e) => { e.stopPropagation(); onToggleFavorite(store.id); }} className="absolute top-3 right-3 p-1.5 z-10"><Heart className={`w-6 h-6 transition-all ${isFavorite ? 'text-red-500 fill-current' : 'text-gray-300'}`} /></button>
    </div>
  </div>
);

// --- Screen Components ---

const HomeScreen = ({ stores, favorites, onToggleFavorite, onSelectStore, notifications, onMarkAllRead }) => {
    const [searchTerm, setSearchTerm] = useState('');
    const [selectedCategory, setSelectedCategory] = useState('所有類別');

    const recommendedStores = useMemo(() => {
        const favoriteCategories = new Set(stores.filter(s => favorites.includes(s.id)).map(s => s.category));
        return stores.filter(s => favoriteCategories.has(s.category) && !favorites.includes(s.id)).slice(0, 5);
    }, [stores, favorites]);

    const filteredStores = useMemo(() => {
        let filtered = stores;
        if (selectedCategory === '我的最愛') filtered = stores.filter(store => favorites.includes(store.id));
        else if (selectedCategory !== '所有類別') filtered = stores.filter(store => store.category === selectedCategory);
        return filtered.filter(store => store.name.toLowerCase().includes(searchTerm.toLowerCase()));
    }, [searchTerm, selectedCategory, favorites, stores]);
    
    const CategoryFilter = ({ selected, onSelect }) => {
        const allCategories = ['我的最愛', '所有類別', ...categories];
        return (<div className="flex items-center space-x-2 overflow-x-auto pb-2 -mx-4 px-4">{allCategories.map(cat => (<button key={cat} onClick={() => onSelect(cat)} className={`px-4 py-2 rounded-full text-sm font-semibold whitespace-nowrap transition-colors ${selected === cat ? 'bg-blue-600 text-white' : 'bg-gray-100 text-gray-700'}`}>{cat === '我的最愛' && <Heart className="w-4 h-4 inline-block mr-1" />}{cat}</button>))}</div>);
    };

    return (
        <>
            <AppHeader title="特約商店" notifications={notifications} onMarkAllRead={onMarkAllRead} />
            <main className="p-4 space-y-4">
                <div className="relative"><Search className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" size={20} /><input type="text" placeholder="搜尋商店名稱..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full h-11 pl-10 pr-4 bg-gray-100 border-transparent rounded-lg focus:ring-2 focus:ring-blue-500" /></div>
                {recommendedStores.length > 0 && (
                    <div>
                        <h2 className="font-bold text-gray-800 mb-2">為您推薦</h2>
                        <div className="flex space-x-4 overflow-x-auto pb-2 -mx-4 px-4">{recommendedStores.map(store => <StoreCard key={store.id} store={store} onSelect={onSelectStore} isFavorite={favorites.includes(store.id)} onToggleFavorite={onToggleFavorite} small />)}</div>
                    </div>
                )}
                <CategoryFilter selected={selectedCategory} onSelect={setSelectedCategory} />
                <div className="space-y-4">{filteredStores.length > 0 ? filteredStores.map(store => <StoreCard key={store.id} store={store} onSelect={onSelectStore} isFavorite={favorites.includes(store.id)} onToggleFavorite={onToggleFavorite} />) : <div className="text-center py-16"><p className="text-gray-500">找不到符合條件的商店。</p></div>}</div>
            </main>
        </>
    );
};

const WishlistScreen = ({ wishlist, currentUser, onWish, onAddWish, notifications, onMarkAllRead }) => {
    const [wishText, setWishText] = useState('');
    const handleSubmit = e => { e.preventDefault(); if (wishText.trim()) { onAddWish(wishText.trim()); setWishText(''); } };
    return (
        <>
            <AppHeader title="許願池" notifications={notifications} onMarkAllRead={onMarkAllRead} />
            <main className="p-4">
                <div className="bg-white rounded-xl shadow-md p-4 space-y-3">{wishlist.map(item => (<div key={item.id} className="flex items-center justify-between p-2"><div><p className="font-semibold text-gray-800">{item.name}</p><p className="text-sm text-gray-500">{item.wishes} 人許願</p></div><button onClick={() => onWish(item.id)} disabled={item.wishedBy.includes(currentUser.id)} className={`w-24 text-white font-bold py-2 px-4 rounded-full transition-colors duration-300 flex items-center justify-center text-sm ${ item.wishedBy.includes(currentUser.id) ? 'bg-gray-400' : 'bg-yellow-500'}`}><ThumbsUp size={16} className="mr-2" />{item.wishedBy.includes(currentUser.id) ? '已許願' : '+1'}</button></div>))}</div>
                <form onSubmit={handleSubmit} className="mt-4 flex gap-2"><input type="text" value={wishText} onChange={e => setWishText(e.target.value)} placeholder="輸入您想要的店家..." className="flex-grow h-12 px-4 bg-gray-100 border-transparent rounded-lg focus:ring-2 focus:ring-blue-500"/><button type="submit" className="h-12 bg-green-500 text-white font-bold px-4 rounded-lg flex items-center justify-center"><PlusCircle size={20} /></button></form>
            </main>
        </>
    );
};

const ProfileScreen = ({ currentUser, onSwitchUser, notifications, onMarkAllRead, onCheckIn, canCheckIn }) => (
    <>
        <AppHeader title="個人資料" notifications={notifications} onMarkAllRead={onMarkAllRead} />
        <main className="p-4 space-y-4">
            <div className="bg-white rounded-xl shadow-md p-6 flex flex-col items-center">
                <img src={currentUser.avatarUrl} alt="Employee Avatar" className="w-24 h-24 rounded-full" />
                <h2 className="text-2xl font-bold mt-4">{currentUser.name}</h2>
                <p className="text-gray-600">{companies[currentUser.companyId].name}</p>
                <div className="mt-4 bg-blue-50 rounded-lg p-3 flex items-center justify-center space-x-2">
                    <Award className="w-6 h-6 text-blue-500" />
                    <span className="font-bold text-xl text-blue-800">{currentUser.points} 點</span>
                </div>
                <button onClick={onCheckIn} disabled={!canCheckIn} className={`mt-4 font-bold py-3 px-6 rounded-lg w-full flex items-center justify-center space-x-2 transition-colors ${canCheckIn ? 'bg-green-500 text-white' : 'bg-gray-300 text-gray-500'}`}>
                    <CheckCircle /><span>{canCheckIn ? '每日簽到 (+10點)' : '今日已簽到'}</span>
                </button>
            </div>
            <div className="bg-white rounded-xl shadow-md p-4">
                <h3 className="font-bold mb-2">我的任務</h3>
                <div className="space-y-2 text-sm">
                    <p className="flex items-center text-gray-500"><CheckCircle className="w-4 h-4 mr-2 text-green-500" /> 成功許願 1 次 (+50點)</p>
                    <p className="flex items-center"><CheckCircle className="w-4 h-4 mr-2 text-gray-300" /> 本週收藏 3 家店家 (+30點)</p>
                </div>
            </div>
            <button onClick={onSwitchUser} className="bg-gray-200 text-gray-700 font-bold py-3 px-6 rounded-lg w-full">切換使用者 (展示用)</button>
        </main>
    </>
);

// --- Main App Component ---
export default function App() {
  const [activeTab, setActiveTab] = useState('home');
  const [currentUser, setCurrentUser] = useState(users['user-1']);
  const [favorites, setFavorites] = useState(currentUser.favorites);
  const [wishlist, setWishlist] = useState(initialWishlist);
  const [selectedStore, setSelectedStore] = useState(null);
  const [notifications, setNotifications] = useState(initialNotifications);

  const today = new Date().toISOString().slice(0, 10);
  const canCheckIn = currentUser.lastCheckIn !== today;

  const handleCheckIn = () => {
      if (canCheckIn) {
          setCurrentUser({ ...currentUser, points: currentUser.points + 10, lastCheckIn: today });
      }
  };

  const handleMarkAllRead = () => setNotifications(notifications.map(n => ({ ...n, read: true })));
  const handleSwitchUser = () => { const nextUser = currentUser.id === 'user-1' ? users['user-2'] : users['user-1']; setCurrentUser(nextUser); setFavorites(nextUser.favorites); };
  const handleToggleFavorite = storeId => setFavorites(prev => prev.includes(storeId) ? prev.filter(id => id !== storeId) : [...prev, storeId]);
  const handleWish = id => setWishlist(currentWishlist => currentWishlist.map(item => item.id === id && !item.wishedBy.includes(currentUser.id) ? { ...item, wishes: item.wishes + 1, wishedBy: [...item.wishedBy, currentUser.id] } : item).sort((a, b) => b.wishes - a.wishes));
  const handleAddWish = wishText => setWishlist(prev => [{ id: Date.now(), name: wishText, category: '其他', wishes: 1, wishedBy: [currentUser.id] }, ...prev].sort((a, b) => b.wishes - a.wishes));

  const renderContent = () => {
    const commonProps = { notifications, onMarkAllRead: handleMarkAllRead };
    switch(activeTab) {
        case 'home': return <HomeScreen stores={stores} favorites={favorites} onToggleFavorite={handleToggleFavorite} onSelectStore={setSelectedStore} {...commonProps} />;
        case 'wishlist': return <WishlistScreen wishlist={wishlist} currentUser={currentUser} onWish={handleWish} onAddWish={handleAddWish} {...commonProps} />;
        case 'profile': return <ProfileScreen currentUser={currentUser} onSwitchUser={handleSwitchUser} onCheckIn={handleCheckIn} canCheckIn={canCheckIn} {...commonProps} />;
        default: return <HomeScreen stores={stores} favorites={favorites} onToggleFavorite={handleToggleFavorite} onSelectStore={setSelectedStore} {...commonProps} />;
    }
  };

  const StoreDetailModal = ({ store, user, onClose }) => {
      const [showQrCode, setShowQrCode] = useState(false);
      const handleShare = () => alert(`已複製優惠連結！\n店家：${store.name}\n優惠：${store.offer}`);
      if (!store) return null;
      return (
          <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-end" onClick={onClose}>
              <div className="bg-gray-100 rounded-t-2xl w-full max-w-lg animate-slide-in-up" onClick={e => e.stopPropagation()}>
                  <div className="w-12 h-1.5 bg-gray-300 rounded-full mx-auto mt-2"></div>
                  {showQrCode ? (
                      <div className="p-4 text-center"><button onClick={() => setShowQrCode(false)} className="absolute top-4 left-4 text-gray-500"><ArrowLeft/></button><img src={user.avatarUrl} alt="Avatar" className="w-20 h-20 rounded-full mx-auto mt-8" /><h3 className="text-xl font-bold mt-2">{user.name}</h3><p className="text-gray-600">{companies[user.companyId].name}</p><img src={`https://placehold.co/256x256/000000/FFFFFF?text=QR+Code`} alt="QR Code" className="w-48 h-48 mx-auto my-4"/><p className="text-sm text-gray-500">請出示此 QR Code 供店家掃描</p></div>
                  ) : (
                      <div className="p-4">
                          <div className="flex items-center mb-4"><img src={store.logo} alt="logo" className="w-20 h-20 rounded-lg" /><div className="ml-4"><h2 className="text-2xl font-bold">{store.name}</h2><p className="text-sm text-gray-500">{store.category}</p></div></div>
                          <div className="space-y-3 p-2"><div><h4 className="font-semibold text-blue-700">專屬優惠</h4><p>{store.offer}</p></div><div><h4 className="font-semibold text-blue-700">注意事項</h4><p className="text-sm">{store.details}</p></div></div>
                          <div className="flex gap-2 mt-4">
                            <button onClick={handleShare} className="w-1/3 bg-gray-200 text-gray-800 font-bold py-3 rounded-lg flex items-center justify-center space-x-2"><Share2 size={20} /><span>分享</span></button>
                            <button onClick={() => setShowQrCode(true)} className="w-2/3 bg-blue-600 text-white font-bold py-3 rounded-lg flex items-center justify-center space-x-2"><QrCode /><span>產生優惠 QR Code</span></button>
                          </div>
                      </div>
                  )}
              </div>
          </div>
      );
  };

  return (
    <div className="bg-gray-50 min-h-screen font-sans">
      <div className="relative pb-16">{renderContent()}</div>
      <BottomNavBar activeTab={activeTab} setActiveTab={setActiveTab} />
      <StoreDetailModal store={selectedStore} user={currentUser} onClose={() => setSelectedStore(null)} />
    </div>
  );
}
